<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>2PS PDI System (Fixed)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Scanner -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- HTML2Canvas for image capture -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- XLSX (SheetJS) for Excel import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        .active-tab {  
            background: rgba(255,255,255,0.2);  
            border-bottom: 3px solid white;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-sky-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center font-bold">QC</div>
                <h1 class="text-2xl font-bold text-indigo-700">2PS PDI System</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="connectionStatus" class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-800">üåê Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="text-gray-600 text-sm" id="currentTime"></div>
                 <!-- Login/Profile Section -->
                <div id="authSection">
                    <button id="loginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <div id="userProfile" class="hidden items-center gap-3">
                        <div class="text-right">
                            <div id="profileUsername" class="font-medium text-sm"></div>
                            <div id="profileRole" class="text-xs text-gray-500"></div>
                        </div>
                        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- User Info Bar -->
    <div id="userInfoBar" class="bg-white border-b border-gray-200 px-4 py-2 hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3 text-sm">
                <span class="text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span>
                <span id="infoBarUsername" class="font-medium text-gray-900"></span>
                <span id="infoBarRole" class="px-2 py-1 rounded text-xs font-medium"></span>
                <span class="px-2 py-1 rounded text-xs font-medium bg-orange-100 text-orange-700">üî• Firebase</span>
            </div>
            <div id="infoBarStatus" class="text-gray-600 text-sm">
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <nav id="mainNav" class="bg-indigo-700 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="navButtonsContainer" class="flex overflow-x-auto no-scrollbar">
                <button data-tab="qc" id="tab-qc" class="tab-btn active-tab py-3 px-5 text-white hover:bg-indigo-800 transition whitespace-nowrap">
                    üîé QC ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                </button>
                <button data-tab="dashboard" id="tab-dashboard" class="tab-btn py-3 px-5 text-white hover:bg-indigo-800 transition whitespace-nowrap">
                    üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                </button>
                <button data-tab="pdi" id="tab-pdi" class="tab-btn py-3 px-5 text-white hover:bg-indigo-800 transition whitespace-nowrap">
                    üß∞ PDI Operation
                </button>
                <button data-tab="admin" id="tab-admin" class="tab-btn py-3 px-5 text-white hover:bg-indigo-800 transition whitespace-nowrap">
                    ‚öôÔ∏è Admin
                </button>
                <button data-tab="user" id="tab-user" class="tab-btn py-3 px-5 text-white hover:bg-indigo-800 transition whitespace-nowrap">
                    üë• User
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="max-w-7xl mx-auto p-4 sm:p-6 hidden">
        
        <!-- ======================================================= -->
        <!-- QC Section -->
        <!-- ======================================================= -->
        <div id="section-qc" class="tab-content">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">üîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏ñ (QC)</h2>
                
                <!-- VIN Input -->
                <div class="space-y-2 mb-6">
                    <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç VIN</label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input id="vinInput" type="text" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç VIN (17 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)"
                                class="flex-1 px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500">
                        <div class="flex gap-2">
                            <button onclick="controllers.qc.searchVin()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-3 rounded-xl">
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                            <button onclick="controllers.camera.open()" id="cameraBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl">
                                üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Car Status Display -->
                <div id="carStatus" class="mb-6 p-4 rounded-xl border bg-blue-50 border-blue-200 hidden">
                    <h4 class="font-semibold text-blue-800 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ñ</h4>
                    <div id="carStatusContent" class="text-sm text-blue-700"></div>
                </div>

                <!-- Photo Upload Section -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-700">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö <span id="photoCountText">(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 3 ‡∏£‡∏π‡∏õ)</span></label>
                        <button id="addPhotoSlotBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                        </button>
                    </div>
                    <div id="photoSlotsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Photo slots will be injected here dynamically -->
                    </div>
                    <div id="photoHint" class="mt-2 text-sm text-amber-800 bg-amber-100 border border-amber-200 rounded px-3 py-2">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </div>
                </div>

                <!-- Status Selection -->
                <div id="statusSection" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö <span class="text-xs text-gray-500">(‡∏Å‡∏î 1, 2 ‡∏ö‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î)</span></label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                        <div class="grid grid-cols-2 gap-3" id="statusButtonsContainer">
                            <button data-status="OK" id="status-OK" class="status-btn bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-semibold relative">
                                ‚úÖ OK
                                <span class="absolute top-1 right-1 bg-white/20 text-xs px-1 rounded">1</span>
                            </button>
                            <button data-status="NG" id="status-NG" class="status-btn bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-semibold relative">
                                ‚ùå NG
                                <span class="absolute top-1 right-1 bg-white/20 text-xs px-1 rounded">2</span>
                            </button>
                        </div>
                        <!-- ACC Button Section -->
                        <div id="accSection" class="hidden text-center">
                             <label class="block text-sm font-medium text-gray-700 mb-3">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                            <button id="accBtn" class="w-full bg-sky-500 hover:bg-sky-600 text-white py-4 rounded-xl font-semibold transition-all">
                                üëç ACC
                            </button>
                        </div>
                    </div>
                     <!-- Note Section -->
                    <div id="noteSection" class="mt-6 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                        <textarea id="qcNoteInput" rows="3" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö..." class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>

                <!-- Defect Details Section -->
                <div id="damageSection" class="mb-6 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <label class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</label>
                        <button id="addDefectCardBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
                        </button>
                    </div>
                    
                    <div id="defectCardsContainer" class="space-y-4">
                        <!-- Defect cards will be added here dynamically -->
                    </div>
                    
                    <div id="noDefectMessage" class="text-center py-8 text-gray-500 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                        <div class="text-4xl mb-2">üîß</div>
                        <div class="text-sm">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="flex justify-center">
                    <button id="saveBtn" disabled
                            class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-2xl font-semibold shadow disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                        <span id="saveBtnText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                        <span id="saveBtnLoading" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
                        </span>
                    </button>
                </div>

                <!-- Recent QC History -->
                <div id="qcHistorySection" class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                    <div id="qcHistoryContainer" class="space-y-3">
                        <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="section-dashboard" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
                    <div class="flex flex-wrap items-center gap-2">
                        <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input id="dashDate" type="date" class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                        <button id="refreshDashboardBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
                            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                        <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-medium">
                            üìä EXPORT EXCEL
                        </button>
                        <button id="shareToLineBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium">
                            üì± ‡∏™‡πà‡∏á LINE
                        </button>
                    </div>
                </div>

                <!-- Combined Work Period Analysis Table -->
                <div id="dashWorkPeriodContainer" class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-blue-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (P1-P5)</h3>
                        <div class="text-sm text-blue-600 bg-blue-100 px-4 py-2 rounded-lg border border-blue-200">
                            <div class="grid grid-cols-5 gap-2 text-center font-medium">
                                <div class="flex flex-col">
                                    <span class="text-blue-800 font-bold">P1</span>
                                    <span class="text-xs">09:00-10:30</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-blue-800 font-bold">P2</span>
                                    <span class="text-xs">10:40-12:30</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-blue-800 font-bold">P3</span>
                                    <span class="text-xs">13:30-15:30</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-blue-800 font-bold">P4</span>
                                    <span class="text-xs">15:40-18:00</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-blue-800 font-bold">P5</span>
                                    <span class="text-xs">18:30-20:30</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Table -->
                    <div class="bg-white border border-blue-200 rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th rowspan="2" class="text-left py-4 px-4 font-semibold text-blue-800 border-r border-blue-200">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</th>
                                        <th colspan="6" class="text-center py-2 px-4 font-semibold text-green-800 bg-green-100 border-b border-green-200">‚úÖ OK + NG (‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô)</th>
                                        <th colspan="6" class="text-center py-2 px-4 font-semibold text-yellow-800 bg-yellow-100 border-b border-yellow-200">üîß REPAIR</th>
                                        <th colspan="6" class="text-center py-2 px-4 font-semibold text-blue-800 bg-blue-100 border-b border-blue-200">üìä TOTAL (OK+NG+REPAIR)</th>
                                    </tr>
                                    <tr>
                                        <!-- OK + NG Headers -->
                                        <th class="text-center py-2 px-2 font-semibold text-green-700 bg-green-50 text-xs">P1</th>
                                        <th class="text-center py-2 px-2 font-semibold text-green-700 bg-green-50 text-xs">P2</th>
                                        <th class="text-center py-2 px-2 font-semibold text-green-700 bg-green-50 text-xs">P3</th>
                                        <th class="text-center py-2 px-2 font-semibold text-green-700 bg-green-50 text-xs">P4</th>
                                        <th class="text-center py-2 px-2 font-semibold text-green-700 bg-green-50 text-xs">P5</th>
                                        <th class="text-center py-2 px-2 font-semibold text-green-700 bg-green-200 text-xs border-r border-green-300">‡∏£‡∏ß‡∏°</th>
                                        <!-- REPAIR Headers -->
                                        <th class="text-center py-2 px-2 font-semibold text-yellow-700 bg-yellow-50 text-xs">P1</th>
                                        <th class="text-center py-2 px-2 font-semibold text-yellow-700 bg-yellow-50 text-xs">P2</th>
                                        <th class="text-center py-2 px-2 font-semibold text-yellow-700 bg-yellow-50 text-xs">P3</th>
                                        <th class="text-center py-2 px-2 font-semibold text-yellow-700 bg-yellow-50 text-xs">P4</th>
                                        <th class="text-center py-2 px-2 font-semibold text-yellow-700 bg-yellow-50 text-xs">P5</th>
                                        <th class="text-center py-2 px-2 font-semibold text-yellow-700 bg-yellow-200 text-xs border-r border-yellow-300">‡∏£‡∏ß‡∏°</th>
                                        <!-- TOTAL Headers -->
                                        <th class="text-center py-2 px-2 font-semibold text-blue-700 bg-blue-50 text-xs">P1</th>
                                        <th class="text-center py-2 px-2 font-semibold text-blue-700 bg-blue-50 text-xs">P2</th>
                                        <th class="text-center py-2 px-2 font-semibold text-blue-700 bg-blue-50 text-xs">P3</th>
                                        <th class="text-center py-2 px-2 font-semibold text-blue-700 bg-blue-50 text-xs">P4</th>
                                        <th class="text-center py-2 px-2 font-semibold text-blue-700 bg-blue-50 text-xs">P5</th>
                                        <th class="text-center py-2 px-2 font-semibold text-blue-700 bg-blue-200 text-xs">‡∏£‡∏ß‡∏°</th>
                                    </tr>
                                </thead>
                                <tbody id="combinedTable">
                                    <tr>
                                        <td colspan="19" class="py-8 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div id="dashStatsCards" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <div class="text-sm text-green-700 mb-1">OK</div>
                        <div id="dashOk" class="text-3xl font-bold text-green-700">0</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">‚ùå</div>
                        <div class="text-sm text-red-700 mb-1">NG</div>
                        <div id="dashNg" class="text-3xl font-bold text-red-700">0</div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">üîß</div>
                        <div class="text-sm text-yellow-700 mb-1">REPAIR</div>
                        <div id="dashRepair" class="text-3xl font-bold text-yellow-700">0</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">üìä</div>
                        <div class="text-sm text-blue-700 mb-1">TOTAL</div>
                        <div id="dashTotal" class="text-3xl font-bold text-blue-700">0</div>
                    </div>
                </div>

                <!-- Data Table -->
                <div id="dashRecordsTableContainer" class="border rounded-xl overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h4 class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4">VIN</th>
                                    <th class="text-left py-3 px-4">‡∏£‡∏∏‡πà‡∏ô</th>
                                    <th class="text-left py-3 px-4">‡∏™‡∏µ</th>
                                    <th class="text-left py-3 px-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="text-left py-3 px-4">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                </tr>
                            </thead>
                            <tbody id="dashTable">
                                <tr>
                                    <td colspan="5" class="py-8 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDI Operation Section -->
        <div id="section-pdi" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">üß∞ PDI Operation</h2>
                    <div class="flex items-center gap-2">
                        <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input id="pdiDate" type="date" class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                        <button id="refreshPdiBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
                            ‡∏Å‡∏£‡∏≠‡∏á
                        </button>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Pending Cars -->
                    <div class="lg:col-span-1">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl">
                            <div class="bg-yellow-100 p-4 rounded-t-xl border-b border-yellow-200">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-bold text-yellow-800">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
                                    <span id="pendingCount" class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-sm font-bold">0</span>
                                </div>
                            </div>
                            <div id="pendingList" class="p-4 space-y-3 max-h-96 overflow-y-auto">
                                <div class="text-center text-gray-500 py-8">
                                    <div class="text-4xl mb-2">üöó</div>
                                    <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Completed Cars -->
                    <div class="lg:col-span-1">
                        <div class="bg-green-50 border border-green-200 rounded-xl">
                            <div class="bg-green-100 p-4 rounded-t-xl border-b border-green-200">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-bold text-green-800">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3>
                                    <div class="flex items-center gap-2">
                                        <span id="completedCount" class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-sm font-bold">0</span>
                                        <select id="statusFilter" class="text-sm border rounded px-2 py-1">
                                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                            <option value="OK">‚úÖ OK</option>
                                            <option value="NG">‚ùå NG</option>
                                            <option value="REPAIR">üîß REPAIR</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="completedList" class="p-4 space-y-3 max-h-96 overflow-y-auto">
                                <div class="text-center text-gray-500 py-8">
                                    <div class="text-4xl mb-2">üìã</div>
                                    <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>
                                    <div class="text-xs mt-2">‡∏£‡∏ñ‡∏à‡∏∞‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏≥ PDI ‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mt-6 bg-gray-100 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                        <span id="progressText" class="text-sm text-gray-600">0/0 (0%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="section-admin" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">‚öôÔ∏è Admin Panel</h2>
                
                <!-- Search Section -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <h3 class="font-bold text-blue-800 mb-3">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <input id="adminVin" class="flex-1 px-3 py-2 border rounded-lg min-w-[200px]" placeholder="‡πÉ‡∏™‡πà VIN">
                        <button id="adminSearchBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                        <button id="importExcelBtnAdmin" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                            <span id="importBtnText">üìä IMPORT EXCEL</span>
                            <svg id="importBtnSpinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                        <input type="file" id="excelUpload" class="hidden" accept=".xlsx, .xls, .csv">
                    </div>
                    <div id="adminSearchResult" class="text-sm text-gray-700"></div>
                </div>
                
                <!-- Admin Edit Form - Centered below search results -->
                <div class="flex justify-center mb-6">
                    <div id="adminEditForm" class="hidden bg-gray-50 border border-gray-200 rounded-xl p-6 w-full max-w-6xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800 text-lg">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <button id="saveAdminChangesBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <!-- ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</label>
                                <div class="relative">
                                    <input id="carModel" type="text" list="carModelList" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <datalist id="carModelList">
                                        <option value="DOLPHIN">
                                        <option value="SEAL5 DM-I">
                                        <option value="SEALION 6 DM-I">
                                        <option value="ATTO3">
                                    </datalist>
                                </div>
                            </div>
                            
                            <!-- ‡∏™‡∏µ‡∏£‡∏ñ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏µ‡∏£‡∏ñ</label>
                                <div class="relative">
                                    <input id="carColor" type="text" list="carColorList" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏µ‡∏£‡∏ñ" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <datalist id="carColorList">
                                        <option value="GREY">
                                        <option value="WHITE">
                                        <option value="WHITE(CREAM)">
                                        <option value="BLUE">
                                        <option value="BLACK">
                                    </datalist>
                                </div>
                            </div>
                            
                            <!-- PDI Date -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">PDI Date (at BYD)</label>
                                <input id="adminPdiDate" type="date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>

                        <!-- NEW STATUS CHANGE SECTION -->
                        <div class="border-t pt-4 mb-4" id="adminStatusChangeContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-3">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πà‡∏ß‡∏ô</label>
                            <div class="flex flex-wrap gap-3">
                                <button data-status="OK" class="admin-status-btn bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-semibold flex items-center gap-2">
                                    ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô OK
                                </button>
                                <button data-status="NG" class="admin-status-btn bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold flex items-center gap-2">
                                    ‚ùå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô NG
                                </button>
                                <button data-status="REPAIR" class="admin-status-btn bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg font-semibold flex items-center gap-2">
                                    üîß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô REPAIR
                                </button>
                            </div>
                        </div>

                        <!-- Defect Cards Section -->
                        <div class="border-t pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-bold text-gray-800">üîß ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</h4>
                                <button id="addAdminDefectCardBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                    ‚ûï Add Position
                                </button>
                            </div>
                            
                            <div id="adminDefectCardsContainer" class="space-y-4">
                                <!-- Defect cards will be added here dynamically -->
                            </div>
                            
                            <div id="adminNoDefectMessage" class="text-center py-8 text-gray-500 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                                <div class="text-4xl mb-2">üîß</div>
                                <div class="text-sm">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "Add Position" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-xs text-gray-500">
                            üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏ó‡∏∏‡∏Å dropdown ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
                        </div>
                    </div>
                </div>

                <!-- Latest Inspection Records Section -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 mb-6">
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-t-2xl border-b border-gray-200">
                        <div class="flex flex-wrap items-center justify-between gap-2">
                            <h3 class="text-xl font-bold text-purple-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-purple-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                                <input id="adminRecordsDate" type="date" class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
                                <button id="refreshAdminRecordsBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm">
                                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                                </button>
                                <button id="sendSummaryToLineBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium">
                                    üì± ‡∏™‡πà‡∏á LINE (‡∏™‡∏£‡∏∏‡∏õ)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div class="p-4 bg-gray-50 border-b border-gray-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white rounded-lg p-3 border">
                                <div class="text-2xl mb-1">üìä</div>
                                <div class="text-xs text-gray-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                <div id="adminTotalCount" class="text-lg font-bold text-gray-800">0</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                                <div class="text-2xl mb-1">‚úÖ</div>
                                <div class="text-xs text-green-700">OK</div>
                                <div id="adminOkCount" class="text-lg font-bold text-green-700">0</div>
                            </div>
                            <div class="bg-red-50 rounded-lg p-3 border border-red-200">
                                <div class="text-2xl mb-1">‚ùå</div>
                                <div class="text-xs text-red-700">NG</div>
                                <div id="adminNgCount" class="text-lg font-bold text-red-700">0</div>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                                <div class="text-2xl mb-1">üîß</div>
                                <div class="text-xs text-yellow-700">REPAIR</div>
                                <div id="adminRepairCount" class="text-lg font-bold text-yellow-700">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Records Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">VIN</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">‡∏£‡∏∏‡πà‡∏ô</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">‡∏™‡∏µ</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">PDI Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-800">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="adminRecordsTable">
                                <tr>
                                    <td colspan="8" class="py-8 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div id="section-user" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                    <button id="addUserBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    </button>
                </div>

                <!-- User Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                        <div class="text-2xl mb-1">üë•</div>
                        <div class="text-sm text-blue-700">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div id="userTotalCount" class="text-xl font-bold text-blue-700">0</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
                        <div class="text-2xl mb-1">üü¢</div>
                        <div class="text-sm text-green-700">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div>
                        <div id="userActiveCount" class="text-xl font-bold text-green-700">0</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 text-center">
                        <div class="text-2xl mb-1">üëë</div>
                        <div class="text-sm text-purple-700">Admin</div>
                        <div id="userAdminCount" class="text-xl font-bold text-purple-700">0</div>
                    </div>
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 text-center">
                        <div class="text-2xl mb-1">üìä</div>
                        <div class="text-sm text-amber-700">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
                        <div id="userOnlineCount" class="text-xl font-bold text-amber-700">1</div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="border border-gray-200 rounded-xl overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h4 class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                                    <th class="text-left py-3 px-4">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                                    <th class="text-left py-3 px-4">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                    <th class="text-left py-3 px-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="text-left py-3 px-4">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="userRecordsTable">
                                <!-- User data will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 hidden px-4 py-2 rounded-lg text-white shadow z-50"></div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-full overflow-auto">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR Code</h3>
                <button id="closeCameraBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <div class="relative">
                    <video id="cameraVideo" autoplay playsinline class="w-full rounded-lg bg-gray-100"></video>
                    <canvas id="cameraCanvas" class="hidden"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="border-2 border-white border-dashed w-64 h-64 rounded-lg"></div>
                    </div>
                </div>
                <div id="scanStatus" class="mt-4 text-center text-gray-600">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...</div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex gap-2 justify-center">
                <button id="closeCameraBtn2" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                    ‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- Photo Modal for full screen view -->
    <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-4xl max-h-full overflow-auto" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 id="photoModalTitle" class="text-lg font-bold text-gray-900"></h3>
                <button id="closePhotoModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <img id="photoModalImage" src="" alt="" class="w-full h-auto max-h-[80vh] object-contain rounded-lg">
            </div>
            <div class="p-4 border-t bg-gray-50 text-center">
                <button id="closePhotoModalBtn2" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
    
    <!-- User Modal -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-lg w-full">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 id="userModalTitle" class="text-lg font-bold text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <button id="closeUserModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="userKeyInput">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input id="userNameInput" type="text" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username (e.g., @user)</label>
                    <input id="userUsernameInput" type="text" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input id="userPasswordInput" type="password" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                    <input id="userDepartmentInput" type="text" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="userRoleInput" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="USER">üë§ USER</option>
                            <option value="ADMIN">üëë ADMIN</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="userStatusInput" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="Active">üü¢ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</option>
                            <option value="Inactive">üî¥ ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-2">
                <button id="cancelUserModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="saveUserBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-sm w-full">
             <div class="p-4 border-b">
                <h3 class="text-lg font-bold text-gray-900 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö 2PS PDI System</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username</label>
                    <input id="loginUsername" type="text" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input id="loginPassword" type="password" class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex items-center">
                    <input id="rememberUser" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="rememberUser" class="ml-2 block text-sm text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-center">
                <button id="loginModalBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium disabled:opacity-75">
                   <span id="loginModalBtnText">Login</span>
               </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-xl shadow-lg max-w-sm w-full">
            <div class="p-6">
                <div class="text-center">
                    <div id="confirmModalIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <h3 id="confirmModalTitle" class="mt-5 text-lg font-semibold text-gray-900"></h3>
                    <div class="mt-2">
                        <p id="confirmModalText" class="text-sm text-gray-500"></p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-center gap-3">
                <button id="confirmModalCancelBtn" type="button" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button id="confirmModalConfirmBtn" type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK v10 (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, update, remove, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        // =======================================================
        // APP CONFIGURATION
        // =======================================================
        const config = {
            firebase: {
                apiKey: "AIzaSyAvQdJ8pPjUudJspWBKR6UB7ctsqBp4WFQ", 
                authDomain: "psservice-bce2f.firebaseapp.com",
                databaseURL: "https://psservice-bce2f-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "psservice-bce2f",
                storageBucket: "psservice-bce2f.firebasestorage.app",
                messagingSenderId: "718173959958",
                appId: "1:718173959958:web:a1e6a184d35f313fd4c237"
            },
            photo: {
                requiredForNew: 3,
                requiredForRecheck: 1,
                maxSize: 800, 
                quality: 0.7 
            },
            qcHistoryLimit: 5
        };

        // =======================================================
        // APP STATE
        // =======================================================
        const state = {
            db: null,
            records: [],
            users: [],
            currentUser: null,
            confirmResolve: null,
            cameraStream: null,
            qc: {
                currentVin: '',
                selectedStatus: '',
                isAccSelected: false,
                photoSlots: [],
                photoCounter: 0,
                defectCards: [],
                defectCardCounter: 0,
            },
            admin: {
                currentEditingVin: '',
                currentEditingRecord: null,
                defectCards: [],
                defectCardCounter: 0,
            },
            user: {
                currentEditingUserKey: null,
            }
        };

        // =======================================================
        // DOM ELEMENTS & UI HELPERS
        // =======================================================
        const ui = {
            $: (id) => document.getElementById(id),

            showToast(message, type = 'success') {
                const toast = this.$('toast');
                toast.textContent = message;
                toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white shadow z-50 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            },
            
            updateTime() {
                this.$('currentTime').textContent = new Date().toLocaleString('th-TH');
            },

            showConfirm({ title, text, confirmText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmColor = 'red' }) {
                return new Promise(resolve => {
                    state.confirmResolve = resolve;

                    this.$('confirmModalTitle').textContent = title;
                    this.$('confirmModalText').textContent = text;
                    this.$('confirmModalConfirmBtn').textContent = confirmText;
                    this.$('confirmModalCancelBtn').textContent = cancelText;

                    const confirmBtn = this.$('confirmModalConfirmBtn');
                    const iconContainer = this.$('confirmModalIcon');
                    const iconSvg = iconContainer.querySelector('svg');

                    // Reset classes before applying new ones
                    confirmBtn.className = 'inline-flex w-full justify-center rounded-md px-3 py-2 text-sm font-semibold text-white shadow-sm sm:w-auto';
                    iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full';
                    iconSvg.className = 'h-6 w-6';

                    if (confirmColor === 'red') {
                        confirmBtn.classList.add('bg-red-600', 'hover:bg-red-500');
                        iconContainer.classList.add('bg-red-100');
                        iconSvg.classList.add('text-red-600');
                    } else { 
                        confirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                        iconContainer.classList.add('bg-blue-100');
                        iconSvg.classList.add('text-blue-600');
                    }
                    
                    // Show the modal
                    this.$('confirmModal').classList.remove('hidden');
                    this.$('confirmModal').classList.add('flex');
                });
            },

            handleConfirm(result) {
                if (state.confirmResolve) {
                    state.confirmResolve(result);
                    state.confirmResolve = null; // Prevent multiple resolutions
                }
                // Hide the modal
                this.$('confirmModal').classList.add('hidden');
                this.$('confirmModal').classList.remove('flex');
            },
            
            copyVin(vin, buttonElement) {
                // Create a temporary textarea element to hold the text to be copied.
                // This is a robust method that works across different browser environments, including iframes.
                const textarea = document.createElement('textarea');
                textarea.value = vin;
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px'; // Position it off-screen to keep it hidden.
                document.body.appendChild(textarea);

                try {
                    textarea.select();
                    document.execCommand('copy'); // Execute the copy command.

                    // Provide visual feedback to the user.
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = '‚úÖ COPIED';
                    this.showToast(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å VIN: ${vin} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000);
                } catch (err) {
                    console.error('Copy failed:', err);
                    this.showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                } finally {
                    // Clean up: remove the temporary textarea from the DOM.
                    document.body.removeChild(textarea);
                }
            },

            downloadImage(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                this.showToast('üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            },

            async copyImageToClipboard(button, url) {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
                    this.showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô LINE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success');
                    const originalText = button.innerHTML;
                    button.innerHTML = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                    setTimeout(() => { button.innerHTML = originalText; }, 2000);
                } catch (error) {
                    console.error('Error copying image:', error);
                    this.showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
                }
            },
        };

        // =======================================================
        // SERVICES (Firebase, Authentication)
        // =======================================================
        const services = {
            db: {
                init() {
                    try {
                        const app = initializeApp(config.firebase);
                        state.db = getDatabase(app);
                        this.listenToConnection();
                        // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Login ‡∏Å‡πà‡∏≠‡∏ô
                        this.loadUsers();
                        // 2. ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå
                        this.loadRecords();
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        ui.showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
                    }
                },
                
                listenToConnection() {
                    const connectedRef = ref(state.db, '.info/connected');
                    onValue(connectedRef, (snap) => {
                        const statusEl = ui.$('connectionStatus');
                        if (snap.val() === true) {
                            statusEl.className = 'text-sm px-3 py-1 rounded-full bg-emerald-100 text-emerald-800';
                            statusEl.textContent = 'üåê Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                        } else {
                            statusEl.className = 'text-sm px-3 py-1 rounded-full bg-red-100 text-red-800';
                            statusEl.textContent = '‚ùå ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                        }
                    });
                },

                loadRecords() {
                    const recordsRef = ref(state.db, 'pdi_records');
                    const limitedQuery = query(recordsRef, limitToLast(500));
                    onValue(limitedQuery, (snapshot) => {
                        const data = snapshot.val();
                        state.records = data ? Object.keys(data).map(key => ({ ...data[key], firebaseKey: key })) : [];
                        
                        // Run cleanup if user is an admin
                        if (state.currentUser && state.currentUser.role === 'ADMIN') {
                            this.runAutomaticCleanup();
                        }

                        const activeTab = document.querySelector('.tab-btn.active-tab')?.dataset.tab;
                        if (activeTab && controllers[activeTab] && typeof controllers[activeTab].refresh === 'function') {
                            controllers[activeTab].refresh();
                        }
                    }, { onlyOnce: false });
                },

                async runAutomaticCleanup() {
                    const lastCleanup = localStorage.getItem('pdiLastCleanup');
                    const now = new Date().getTime();
                    // Run once every 24 hours
                    if (lastCleanup && (now - parseInt(lastCleanup, 10)) < 24 * 60 * 60 * 1000) {
                        return; 
                    }

                    console.log("Running automatic cleanup for records older than 1 year...");

                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                    const cutoffTimestamp = oneYearAgo.getTime();

                    // NOTE: This cleanup only runs on the last 500 records due to client-side limitations.
                    // For a full database cleanup, a server-side function (e.g., Firebase Cloud Function) is recommended.
                    const recordsToDelete = state.records.filter(record => {
                        const recordTimestamp = new Date(record.timestamp).getTime();
                        return recordTimestamp < cutoffTimestamp;
                    });

                    if (recordsToDelete.length > 0) {
                        console.log(`Found ${recordsToDelete.length} records to delete.`);
                        const updates = {};
                        recordsToDelete.forEach(record => {
                            updates[`pdi_records/${record.firebaseKey}`] = null;
                        });

                        try {
                            await update(ref(state.db), updates);
                            ui.showToast(`üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ${recordsToDelete.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`, 'success');
                            localStorage.setItem('pdiLastCleanup', now.toString());
                        } catch (error) {
                            console.error("Error during automatic cleanup:", error);
                            ui.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤', 'error');
                        }
                    } else {
                        console.log("No old records found in the loaded data to clean up.");
                        localStorage.setItem('pdiLastCleanup', now.toString()); // Update timestamp to prevent re-running
                    }
                },

                loadUsers() {
                     const usersRef = ref(state.db, 'pdi_users');
                     onValue(usersRef, (snapshot) => {
                        const data = snapshot.val();
                        state.users = data ? Object.keys(data).map(key => ({ ...data[key], firebaseKey: key })) : [];
                        if (document.querySelector('.tab-btn.active-tab')?.dataset.tab === 'user') {
                            controllers.user.refresh();
                        }
                     }, { onlyOnce: false });
                },

                saveRecord(record) {
                    const newRecordRef = push(ref(state.db, 'pdi_records'));
                    return set(newRecordRef, record);
                },
                updateRecord(key, updates) {
                    return update(ref(state.db, `pdi_records/${key}`), updates);
                },
                deleteRecord(key) {
                    return remove(ref(state.db, `pdi_records/${key}`));
                },
                saveUser(key, userData) {
                    if (key) {
                        return update(ref(state.db, `pdi_users/${key}`), userData);
                    } else {
                        return set(push(ref(state.db, 'pdi_users')), userData);
                    }
                },
                deleteUser(key) {
                    return remove(ref(state.db, `pdi_users/${key}`));
                }
            },

            auth: {
                login(username, password) {
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            if (!username || !password) return reject(new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password'));
                            const matchedUser = state.users.find(u => u.username === username && u.password === password);
                            
                            if (matchedUser) {
                                if (matchedUser.status !== 'Active') return reject(new Error('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'));
                                state.currentUser = matchedUser;
                                if (ui.$('rememberUser').checked) {
                                    localStorage.setItem('pdiSystemUsername', username);
                                } else {
                                    localStorage.removeItem('pdiSystemUsername');
                                }
                                resolve(matchedUser);
                            } else {
                                reject(new Error('Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'));
                            }
                        }, 500);
                    });
                },
                logout() {
                    state.currentUser = null;
                },
                updateUIAfterLogin() {
                    if (!state.currentUser) {
                        ui.$('loginBtn').classList.remove('hidden');
                        ui.$('userProfile').classList.add('hidden');
                        ui.$('mainNav').classList.add('hidden');
                        ui.$('mainContent').classList.add('hidden');
                        ui.$('userInfoBar').classList.add('hidden');
                        return;
                    };
                    
                    ui.$('loginBtn').classList.add('hidden');
                    const profile = ui.$('userProfile');
                    profile.classList.remove('hidden');
                    profile.classList.add('flex');
                    ui.$('profileUsername').textContent = state.currentUser.name;
                    ui.$('profileRole').textContent = state.currentUser.role;
                    
                    ui.$('userInfoBar').classList.remove('hidden');
                    ui.$('infoBarUsername').textContent = state.currentUser.name;
                    const roleEl = ui.$('infoBarRole');
                    roleEl.textContent = state.currentUser.role;
                    roleEl.className = `px-2 py-1 rounded text-xs font-medium ${state.currentUser.role === 'ADMIN' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}`;
                    ui.$('infoBarStatus').textContent = `üîì ${state.currentUser.status}`;

                    ui.$('mainNav').classList.remove('hidden');
                    ui.$('mainContent').classList.remove('hidden');
                    controllers.qc.renderHistory();
                },
                applyAccessControl() {
                    if (!state.currentUser) return;
                    
                    const isAdmin = state.currentUser.role === 'ADMIN';
                    ['dashboard', 'pdi', 'admin', 'user'].forEach(tab => {
                        ui.$(`tab-${tab}`).style.display = isAdmin ? 'block' : 'none';
                    });
                    
                    app.switchTab('qc');
                }
            }
        };

        // =======================================================
        // CONTROLLERS
        // =======================================================
        const controllers = {};
        
        // =======================================================
        // APP INITIALIZATION
        // =======================================================
        const app = {
            init() {
                console.log("App initializing (Optimized for faster login)...");
                this.populateControllers();
                this.setupEventListeners();
                
                Object.values(controllers).forEach(controller => {
                    if (typeof controller.init === 'function') controller.init();
                });

                // FIX: Expose objects to global scope for onclick attributes in HTML
                window.controllers = controllers;
                window.ui = ui;

                ui.updateTime();
                setInterval(() => ui.updateTime(), 1000);

                // Show login modal first so user can interact
                controllers.auth.checkLoginState();
                
                // Start loading data in the background
                services.db.init();
            },

            populateControllers() {
                Object.assign(controllers, {
                    auth: {
                        openLoginModal() {
                            ui.$('loginModal').classList.remove('hidden');
                            ui.$('loginModal').classList.add('flex');
                            
                            const savedUsername = localStorage.getItem('pdiSystemUsername');
                            if (savedUsername) {
                                ui.$('loginUsername').value = savedUsername;
                                ui.$('rememberUser').checked = true;
                                ui.$('loginPassword').focus();
                            } else {
                                ui.$('loginUsername').value = '';
                                ui.$('rememberUser').checked = false;
                                ui.$('loginUsername').focus();
                            }
                        },
                        closeLoginModal() {
                            ui.$('loginModal').classList.add('hidden');
                            ui.$('loginModal').classList.remove('flex');
                        },
                        async handleLogin() {
                            const btn = ui.$('loginModalBtn');
                            const btnText = ui.$('loginModalBtnText');
                            btn.disabled = true;
                            btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

                            try {
                                const username = ui.$('loginUsername').value.trim();
                                const password = ui.$('loginPassword').value.trim();
                                const user = await services.auth.login(username, password);
                                services.auth.updateUIAfterLogin();
                                services.auth.applyAccessControl();
                                this.closeLoginModal();
                                ui.showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${user.name}!`, 'success');
                            } catch (error) {
                                ui.showToast(error.message, 'error');
                            } finally {
                                btn.disabled = false;
                                btnText.textContent = 'Login';
                                ui.$('loginPassword').value = '';
                            }
                        },
                        handleLogout(showMsg = true) {
                            services.auth.logout();
                            services.auth.updateUIAfterLogin();
                            this.openLoginModal();
                            if (showMsg) ui.showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        },
                        checkLoginState() {
                            this.handleLogout(false);
                        }
                    },
                    qc: {
                        init() {
                             ui.$('addPhotoSlotBtn').addEventListener('click', () => this.addPhotoSlot());
                             ui.$('statusButtonsContainer').addEventListener('click', (e) => {
                                const btn = e.target.closest('.status-btn');
                                if (btn) this.selectStatus(btn.dataset.status);
                             });
                             ui.$('accBtn').addEventListener('click', () => this.selectAcc());
                             ui.$('addDefectCardBtn').addEventListener('click', () => this.addDefectCard());
                             ui.$('saveBtn').addEventListener('click', () => this.saveRecord());
                             ui.$('vinInput').addEventListener('input', (e) => {
                                let value = e.target.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
                                if (value.length > 17) value = value.slice(0, 17);
                                e.target.value = value;
                             });
                        },
                        searchVin() {
                            const vin = ui.$('vinInput').value.trim();
                            if (vin.length !== 17) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç VIN ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 17 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
                                return;
                            }
                            
                            this.resetQcForm(false); // Reset form but keep VIN
                            ui.$('vinInput').value = vin; // Re-apply VIN
                            
                            state.qc.currentVin = vin;
                            ui.$('carStatus').classList.remove('hidden');
                            ui.$('statusSection').classList.remove('hidden');
                            
                            const vinRecords = state.records.filter(r => r.vin === vin);
                            const statusContent = ui.$('carStatusContent');
                            const latestRecord = vinRecords.length > 0 ? vinRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0] : null;
                            
                            const photoSection = ui.$('photoSlotsContainer').parentElement;

                            if (latestRecord) {
                                statusContent.innerHTML = `
                                    <div class="text-blue-700">
                                        <div><strong>VIN:</strong> ${vin}</div>
                                        <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${latestRecord.status}</div>
                                        <div><strong>‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà:</strong> ${vinRecords.length}</div>
                                        <div><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${new Date(latestRecord.timestamp).toLocaleString('th-TH')}</div>
                                    </div>`;

                                if (latestRecord.status === 'OK') {
                                    photoSection.classList.add('hidden');
                                    statusContent.innerHTML += `<div class="mt-2 font-semibold text-green-700 bg-green-100 p-2 rounded-lg">‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ OK ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>`;
                                    state.qc.photoSlots = [];
                                } else {
                                    photoSection.classList.remove('hidden');
                                    this.addPhotoSlot(config.photo.requiredForRecheck);
                                }
                            } else {
                                statusContent.innerHTML = `
                                    <div class="text-blue-700">
                                        <div><strong>VIN:</strong> ${vin}</div>
                                        <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
                                    </div>`;
                                photoSection.classList.remove('hidden');
                                this.addPhotoSlot(config.photo.requiredForNew);
                            }

                            this.updateSaveButton();
                        },
                        addPhotoSlot(count = 1) {
                            for(let i=0; i<count; i++){
                                state.qc.photoCounter++;
                                state.qc.photoSlots.push({ id: state.qc.photoCounter, data: null });
                            }
                            this.renderPhotoSlots();
                            this.updateSaveButton();
                        },
                        removePhotoSlot(id) {
                            state.qc.photoSlots = state.qc.photoSlots.filter(slot => slot.id !== id);
                            this.renderPhotoSlots();
                            this.updateSaveButton();
                        },
                        selectPhoto(id) {
                            ui.$(`photo-input-${id}`).click();
                        },
                        handlePhotoUpload(event, id) {
                            const file = event.target.files[0];
                            if (!file || !file.type.startsWith('image/')) return;

                            const reader = new FileReader();
                            reader.onload = e => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    const MAX_SIZE = config.photo.maxSize;
                                    let { width, height } = img;
                                    if (width > height) {
                                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                                    } else {
                                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                                    }
                                    canvas.width = width; canvas.height = height;
                                    ctx.drawImage(img, 0, 0, width, height);
                                    const compressedImageData = canvas.toDataURL('image/jpeg', config.photo.quality);
                                    const photoSlot = state.qc.photoSlots.find(slot => slot.id === id);
                                    if (photoSlot) photoSlot.data = compressedImageData;
                                    this.renderPhotoSlots();
                                    this.updateSaveButton();
                                };
                                img.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        },
                        renderPhotoSlots() {
                            const container = ui.$('photoSlotsContainer');
                            container.innerHTML = state.qc.photoSlots.map(slot => `
                                <div class="bg-white rounded-xl border border-gray-200 p-4">
                                    <div class="font-semibold mb-3">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${slot.id}</div>
                                    <div onclick="controllers.qc.selectPhoto(${slot.id})" class="relative rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 h-40 flex items-center justify-center cursor-pointer hover:bg-gray-100 transition">
                                        <div id="photo-placeholder-${slot.id}" class="text-center text-gray-500 ${slot.data ? 'hidden' : ''}">
                                            <div class="text-3xl mb-1">üì∑</div>
                                            <div class="text-xs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>
                                        </div>
                                        <img id="photo-img-${slot.id}" class="w-full h-full object-cover rounded-lg ${slot.data ? '' : 'hidden'}" src="${slot.data || ''}" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${slot.id}">
                                    </div>
                                    <div class="mt-3 flex gap-2">
                                        <button onclick="controllers.qc.selectPhoto(${slot.id})" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">‡∏ñ‡πà‡∏≤‡∏¢/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
                                        <button onclick="controllers.qc.removePhotoSlot(${slot.id})" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
                                    </div>
                                    <input id="photo-input-${slot.id}" type="file" accept="image/*" class="hidden" onchange="controllers.qc.handlePhotoUpload(event, ${slot.id})">
                                </div>
                            `).join('');
                        },
                        selectStatus(status) {
                            state.qc.selectedStatus = status;
                            
                            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('ring-4', 'ring-white', 'ring-opacity-60'));
                            ui.$(`status-${status}`).classList.add('ring-4', 'ring-white', 'ring-opacity-60');
                            
                            ui.$('damageSection').classList.toggle('hidden', status !== 'NG');
                            ui.$('noteSection').classList.remove('hidden');

                            if (status === 'OK') {
                                ui.$('accSection').classList.remove('hidden');
                            } else {
                                ui.$('accSection').classList.add('hidden');
                                if (state.qc.isAccSelected) {
                                    this.selectAcc(false); // Deselect if not OK
                                }
                            }
                            this.updateSaveButton();
                        },
                        selectAcc(forceState = null) {
                            state.qc.isAccSelected = forceState !== null ? forceState : !state.qc.isAccSelected;
                            const accBtn = ui.$('accBtn');
                            if (state.qc.isAccSelected) {
                                accBtn.classList.add('ring-4', 'ring-white', 'ring-opacity-60', 'bg-sky-700');
                                accBtn.classList.remove('bg-sky-500', 'hover:bg-sky-600');
                                ui.showToast('üëç ACC Selected', 'success');
                            } else {
                                accBtn.classList.remove('ring-4', 'ring-white', 'ring-opacity-60', 'bg-sky-700');
                                accBtn.classList.add('bg-sky-500', 'hover:bg-sky-600');
                            }
                        },
                        updateSaveButton() {
                            const hasVin = state.qc.currentVin.trim().length === 17;
                            const hasStatus = state.qc.selectedStatus !== '';

                            const latestRecord = state.records.filter(r => r.vin === state.qc.currentVin).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                            const isPreviouslyOk = latestRecord && latestRecord.status === 'OK';
                            
                            let requiredPhotos = 0;
                            if (!isPreviouslyOk) {
                                requiredPhotos = latestRecord ? config.photo.requiredForRecheck : config.photo.requiredForNew;
                            }
                            const hasEnoughPhotos = isPreviouslyOk || state.qc.photoSlots.filter(slot => slot.data).length >= requiredPhotos;

                            ui.$('saveBtn').disabled = !(hasVin && hasStatus && hasEnoughPhotos);
                            const photoSection = ui.$('photoSlotsContainer').parentElement;
                            if (!photoSection.classList.contains('hidden')) {
                                ui.$('photoHint').classList.toggle('hidden', hasEnoughPhotos);
                                ui.$('photoCountText').textContent = `(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ${requiredPhotos} ‡∏£‡∏π‡∏õ)`;
                            } else {
                                ui.$('photoHint').classList.add('hidden');
                            }
                        },
                        async saveRecord() {
                           // Implementation from original code, adapted for state management
                            if (!state.qc.currentVin || state.qc.currentVin.length !== 17) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç VIN ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 17 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error'); return;
                            }
                            if (!state.qc.selectedStatus) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error'); return;
                            }

                            const latestRecord = state.records.filter(r => r.vin === state.qc.currentVin).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                            const isPreviouslyOk = latestRecord && latestRecord.status === 'OK';
                            const uploadedPhotos = state.qc.photoSlots.filter(slot => slot.data);
                            
                            if (isPreviouslyOk) {
                                const confirmed = await ui.showConfirm({
                                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
                                    text: `‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ OK ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${state.qc.selectedStatus} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                                    confirmColor: 'blue'
                                });
                                if (!confirmed) return;

                                const historyEntry = { editor: state.currentUser.name, editTimestamp: new Date().toISOString(), previousStatus: 'OK', newStatus: state.qc.selectedStatus, note: ui.$('qcNoteInput').value.trim() };
                                const updates = {
                                    status: state.qc.selectedStatus,
                                    accStatus: state.qc.selectedStatus === 'OK' ? state.qc.isAccSelected : false,
                                    note: ui.$('qcNoteInput').value.trim(),
                                    defects: state.qc.selectedStatus === 'NG' ? (latestRecord.defects || []).concat(state.qc.defectCards) : (latestRecord.defects || []),
                                    editHistory: latestRecord.editHistory ? [...latestRecord.editHistory, historyEntry] : [historyEntry],
                                    lastModified: new Date().toISOString(),
                                    modifiedBy: `${state.currentUser.name} (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ OK)`
                                };
                                services.db.updateRecord(latestRecord.firebaseKey, updates)
                                    .then(() => { ui.showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); this.resetQcForm(); })
                                    .catch(err => { console.error(err); ui.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); });
                            } else {
                                let finalStatus = state.qc.selectedStatus;

                                // If it's a re-check of a bad car and the new status is NG, change to REPAIR automatically.
                                if (latestRecord && (latestRecord.status === 'NG' || latestRecord.status === 'REPAIR') && state.qc.selectedStatus === 'NG') {
                                    finalStatus = 'REPAIR';
                                    ui.showToast('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö NG ‡∏ã‡πâ‡∏≥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô REPAIR ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'success');
                                }

                                const record = {
                                    id: Date.now(),
                                    vin: state.qc.currentVin,
                                    status: finalStatus, // Use the potentially modified status
                                    accStatus: finalStatus === 'OK' ? state.qc.isAccSelected : false, // ACC is only for OK
                                    note: ui.$('qcNoteInput').value.trim(),
                                    defects: [...state.qc.defectCards],
                                    timestamp: new Date().toISOString(),
                                    inspector: state.currentUser.name,
                                    photos: uploadedPhotos.map(slot => slot.data)
                                };
                                services.db.saveRecord(record)
                                    .then(() => { ui.showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); this.resetQcForm(); })
                                    .catch(err => { console.error(err); ui.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); });
                            }
                        },
                        resetQcForm(fullReset = true) {
                            if (fullReset) state.qc.currentVin = '';
                            state.qc.selectedStatus = '';
                            state.qc.isAccSelected = false;
                            state.qc.photoSlots = [];
                            state.qc.photoCounter = 0;
                            state.qc.defectCards = [];
                            state.qc.defectCardCounter = 0;
                            
                            if (fullReset) ui.$('vinInput').value = '';
                            ui.$('carStatus').classList.add('hidden');
                            ui.$('statusSection').classList.add('hidden');
                            ui.$('damageSection').classList.add('hidden');
                            ui.$('noteSection').classList.add('hidden');
                            ui.$('qcNoteInput').value = '';
                            ui.$('defectCardsContainer').innerHTML = '';
                            ui.$('noDefectMessage').classList.remove('hidden');
                            ui.$('accSection').classList.add('hidden');
                            this.selectAcc(false);

                            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('ring-4', 'ring-white', 'ring-opacity-60'));
                            
                            ui.$('photoSlotsContainer').innerHTML = '';
                            if (fullReset) this.addPhotoSlot(config.photo.requiredForNew);
                            this.updateSaveButton();
                        },
                        addDefectCard() {
                            state.qc.defectCardCounter++;
                            const cardId = `defect-${state.qc.defectCardCounter}`;
                            state.qc.defectCards.push({ id: cardId, position: `Position ${state.qc.defectCardCounter}`, stockStatus: '', categoryDefect: '', defectDescription: '', ngStatus: '', statusRepair: '', repairDate: '' });
                            this.renderDefectCards();
                            ui.$('noDefectMessage').classList.add('hidden');
                        },
                        removeDefectCard(cardId) {
                            state.qc.defectCards = state.qc.defectCards.filter(card => card.id !== cardId);
                            this.renderDefectCards();
                            if (state.qc.defectCards.length === 0) ui.$('noDefectMessage').classList.remove('hidden');
                        },
                        updateDefectCard(cardId, field, value) {
                            const card = state.qc.defectCards.find(c => c.id === cardId);
                            if (card) card[field] = value;
                        },
                        renderDefectCards() {
                            const container = ui.$('defectCardsContainer');
                            container.innerHTML = state.qc.defectCards.map(card => `
                                <div class="bg-white border-2 border-red-200 rounded-xl p-6 relative">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-bold text-red-800 flex items-center gap-2">üîß ${card.position}</h4>
                                        <button onclick="controllers.qc.removeDefectCard('${card.id}')" class="text-red-500 hover:text-red-700 bg-red-100 hover:bg-red-200 w-8 h-8 rounded-full flex items-center justify-center transition-colors">‚úï</button>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Status</label>
                                            <select onchange="controllers.qc.updateDefectCard('${card.id}', 'stockStatus', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                                <option value="IN_STOCK" ${card.stockStatus === 'IN_STOCK' ? 'selected' : ''}>üì¶ IN STOCK</option>
                                                <option value="OUT_OF_STOCK" ${card.stockStatus === 'OUT_OF_STOCK' ? 'selected' : ''}>üì≠ OUT OF STOCK</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Category Defect</label>
                                            <select onchange="controllers.qc.updateDefectCard('${card.id}', 'categoryDefect', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                                <option value="PAINT" ${card.categoryDefect === 'PAINT' ? 'selected' : ''}>üé® PAINT</option>
                                                <option value="BODY" ${card.categoryDefect === 'BODY' ? 'selected' : ''}>üöó BODY</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">NG Status</label>
                                            <select onchange="controllers.qc.updateDefectCard('${card.id}', 'ngStatus', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                                <option value="MINOR" ${card.ngStatus === 'MINOR' ? 'selected' : ''}>üü° MINOR</option>
                                                <option value="MAJOR" ${card.ngStatus === 'MAJOR' ? 'selected' : ''}>üü† MAJOR</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                        <textarea rows="2" onchange="controllers.qc.updateDefectCard('${card.id}', 'defectDescription', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">${card.defectDescription}</textarea>
                                    </div>
                                </div>
                            `).join('');
                        },
                        updateQcHistoryStatus(firebaseKey, newStatus) {
                            if (!state.currentUser) return ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                            const updates = {
                                status: newStatus,
                                accStatus: newStatus === 'OK' ? true : false,
                                lastModified: new Date().toISOString(),
                                modifiedBy: `${state.currentUser.name} (‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ QC)`,
                            };
                            services.db.updateRecord(firebaseKey, updates)
                                .then(() => ui.showToast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'))
                                .catch(err => { console.error(err); ui.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); });
                        },
                        renderHistory() {
                            if (!state.currentUser) return;
                            const historyContainer = ui.$('qcHistoryContainer');
                            const userRecords = state.records
                                .filter(r => r.inspector === state.currentUser.name)
                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                                .slice(0, config.qcHistoryLimit);

                            if (userRecords.length === 0) {
                                historyContainer.innerHTML = '<p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>';
                                return;
                            }
                            historyContainer.innerHTML = userRecords.map(record => {
                                const statusColor = record.status === 'OK' ? 'bg-green-100 text-green-800' : record.status === 'NG' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                                const accBadge = record.accStatus ? `<span class="px-1.5 py-0.5 rounded text-xs font-bold bg-sky-100 text-sky-800">ACC</span>` : '';
                                return `
                                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="font-semibold text-gray-900">${record.vin}</span>
                                                <div class="text-xs text-gray-500 mt-1">${new Date(record.timestamp).toLocaleString('th-TH')}</div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                ${accBadge}
                                                <span class="px-2 py-1 rounded font-medium text-xs ${statusColor}">${record.status}</span>
                                            </div>
                                        </div>
                                        <div class="mt-3 pt-3 border-t flex justify-end items-center gap-2">
                                            <span class="text-xs text-gray-500 mr-auto">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                            <button onclick="controllers.qc.updateQcHistoryStatus('${record.firebaseKey}', 'OK')" class="bg-green-100 hover:bg-green-200 text-green-800 px-2 py-1 rounded-md text-xs font-semibold">OK</button>
                                            <button onclick="controllers.qc.updateQcHistoryStatus('${record.firebaseKey}', 'NG')" class="bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded-md text-xs font-semibold">NG</button>
                                            <button onclick="controllers.qc.updateQcHistoryStatus('${record.firebaseKey}', 'REPAIR')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-2 py-1 rounded-md text-xs font-semibold">REPAIR</button>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        },
                        refresh(){
                            this.renderHistory();
                        }
                    },
                    dashboard: {
                        init() {
                            ui.$('refreshDashboardBtn').addEventListener('click', () => this.refresh());
                            ui.$('exportExcelBtn').addEventListener('click', () => this.exportExcel());
                            ui.$('shareToLineBtn').addEventListener('click', () => controllers.line.sendDashboardToLine());
                            ui.$('dashDate').value = new Date().toISOString().split('T')[0];
                        },
                        exportExcel() {
                            const selectedDate = ui.$('dashDate').value;
                            if (!selectedDate) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô export', 'error');
                                return;
                            }

                            ui.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel...', 'success');

                            // 1. Filter records by date and exclude imported ones
                            let filteredRecords = state.records.filter(r => 
                                !r.imported && 
                                r.timestamp && 
                                new Date(r.timestamp).toISOString().split('T')[0] === selectedDate
                            );

                            // 2. Group records by VIN to get count and latest record
                            const vinGroups = filteredRecords.reduce((acc, record) => {
                                if (!acc[record.vin]) {
                                    acc[record.vin] = [];
                                }
                                acc[record.vin].push(record);
                                return acc;
                            }, {});
                            
                            const latestRecords = Object.keys(vinGroups).map(vin => {
                                const sortedGroup = vinGroups[vin].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                                return sortedGroup[0];
                            });

                            // 3. Define periods for time calculation
                            const periods = [ 
                                { name: 'P1', start: 9, end: 10.5 }, 
                                { name: 'P2', start: 10.67, end: 12.5 }, 
                                { name: 'P3', start: 13.5, end: 15.5 }, 
                                { name: 'P4', start: 15.67, end: 18 }, 
                                { name: 'P5', start: 18.5, end: 20.5 }
                            ];
                            
                            const getPeriod = (timestamp) => {
                                const recordTime = new Date(timestamp);
                                const hour = recordTime.getHours() + recordTime.getMinutes() / 60;
                                const period = periods.find(p => hour >= p.start && hour < p.end);
                                return period ? period.name : 'N/A';
                            };
                            
                            // 4. Map the data to the desired format
                            const exportData = latestRecords
                                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)) // Sort by time for sequential numbering
                                .map((record, index) => {
                                    return {
                                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': new Date(record.timestamp).toLocaleDateString('th-TH'),
                                        '‡∏•‡∏≥‡∏î‡∏±‡∏ö': index + 1,
                                        'VIN (Vehicle Identification Number)': record.vin,
                                        'Model': record.adminData?.carModel || 'N/A',
                                        'Status': record.status === 'REPAIR' ? 'NG' : record.status,
                                        'Status RE PDI': vinGroups[record.vin].length,
                                        '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤': getPeriod(record.timestamp),
                                        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': record.note || ''
                                    };
                            });

                            if (exportData.length === 0) {
                                ui.showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
                                return;
                            }

                            // 5. Create and download the Excel file
                            const worksheet = XLSX.utils.json_to_sheet(exportData);
                            const workbook = XLSX.utils.book_new();
                            XLSX.utils.book_append_sheet(workbook, worksheet, 'Dashboard Report');
                            
                            const colWidths = Object.keys(exportData[0]).map(key => ({
                                wch: Math.max(
                                    key.length,
                                    ...exportData.map(row => (row[key] || "").toString().length)
                                ) + 2
                            }));
                            worksheet['!cols'] = colWidths;
                            
                            const fileName = `PDI_Dashboard_Report_${selectedDate}.xlsx`;
                            XLSX.writeFile(workbook, fileName);

                            ui.showToast('‚úÖ Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        },
                        refresh() {
                            const selectedDate = ui.$('dashDate').value;
                            let filteredRecords = state.records.filter(r => !r.imported); // Exclude imported records
                            if (selectedDate) {
                                filteredRecords = filteredRecords.filter(record => record.timestamp && new Date(record.timestamp).toISOString().split('T')[0] === selectedDate);
                            }
                            const latestByVin = {};
                            filteredRecords.forEach(record => {
                                if (!latestByVin[record.vin] || new Date(record.timestamp) > new Date(latestByVin[record.vin].timestamp)) {
                                    latestByVin[record.vin] = record;
                                }
                            });
                            const latestRecords = Object.values(latestByVin);
                            
                            const okCount = latestRecords.filter(r => r.status === 'OK').length;
                            const ngCount = latestRecords.filter(r => r.status === 'NG').length;
                            const repairCount = latestRecords.filter(r => r.status === 'REPAIR').length;
                            const totalCount = latestRecords.length;
                            
                            ui.$('dashOk').textContent = okCount;
                            ui.$('dashNg').textContent = ngCount;
                            ui.$('dashRepair').textContent = repairCount;
                            ui.$('dashTotal').textContent = totalCount;
                            
                            this.updateWorkPeriodTables(filteredRecords);
                            
                            const tbody = ui.$('dashTable');
                            if (latestRecords.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                                return;
                            }
                            
                            tbody.innerHTML = latestRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(record => {
                                const statusColor = record.status === 'OK' ? 'text-green-700' : record.status === 'NG' ? 'text-red-700' : 'text-yellow-700';
                                return `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="py-2 px-4 font-medium">${record.vin}</td>
                                        <td class="py-2 px-4">${record.adminData?.carModel || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</td>
                                        <td class="py-2 px-4">${record.adminData?.carColor || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</td>
                                        <td class="py-2 px-4 ${statusColor}">${record.status}</td>
                                        <td class="py-2 px-4">${new Date(record.timestamp).toLocaleString('th-TH')}</td>
                                    </tr>
                                `;
                            }).join('');
                        },
                        updateWorkPeriodTables(filteredRecords) {
                             const periods = [ { name: 'P1', start: 9, end: 10.5 }, { name: 'P2', start: 10.67, end: 12.5 }, { name: 'P3', start: 13.5, end: 15.5 }, { name: 'P4', start: 15.67, end: 18 }, { name: 'P5', start: 18.5, end: 20.5 }];
                            const carModels = ['DOLPHIN', 'SEAL5 DM-I', 'SEALION 6 DM-I', 'ATTO3', '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'];
                            const okngData = {}, repairData = {}, totalData = {};
                            carModels.forEach(model => {
                                okngData[model] = { P1: 0, P2: 0, P3: 0, P4: 0, P5: 0, total: 0 };
                                repairData[model] = { P1: 0, P2: 0, P3: 0, P4: 0, P5: 0, total: 0 };
                                totalData[model] = { P1: 0, P2: 0, P3: 0, P4: 0, P5: 0, total: 0 };
                            });
                            filteredRecords.forEach(record => {
                                const recordTime = new Date(record.timestamp);
                                const hour = recordTime.getHours() + recordTime.getMinutes() / 60;
                                const carModel = record.adminData?.carModel || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';
                                let period = null;
                                periods.forEach(p => { if (hour >= p.start && hour < p.end) period = p.name; });
                                if (period && carModels.includes(carModel)) {
                                    if (record.status === 'OK' || record.status === 'NG') { okngData[carModel][period]++; okngData[carModel].total++; }
                                    if (record.status === 'REPAIR') { repairData[carModel][period]++; repairData[carModel].total++; }
                                    totalData[carModel][period]++; totalData[carModel].total++;
                                }
                            });
                            
                            const combinedTableBody = ui.$('combinedTable');
                            combinedTableBody.innerHTML = carModels.map(model => {
                                if (totalData[model].total === 0) return '';
                                return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-3 px-4 font-medium text-gray-800 border-r border-gray-200">${model}</td>
                                    ${['P1','P2','P3','P4','P5'].map(p => `<td class="py-3 px-2 text-center text-xs ${okngData[model][p] > 0 ? 'bg-green-100 font-semibold' : ''}">${okngData[model][p]}</td>`).join('')}
                                    <td class="py-3 px-2 text-center text-xs bg-green-200 font-bold text-green-800 border-r border-green-300">${okngData[model].total}</td>
                                    ${['P1','P2','P3','P4','P5'].map(p => `<td class="py-3 px-2 text-center text-xs ${repairData[model][p] > 0 ? 'bg-yellow-100 font-semibold' : ''}">${repairData[model][p]}</td>`).join('')}
                                    <td class="py-3 px-2 text-center text-xs bg-yellow-200 font-bold text-yellow-800 border-r border-yellow-300">${repairData[model].total}</td>
                                    ${['P1','P2','P3','P4','P5'].map(p => `<td class="py-3 px-2 text-center text-xs ${totalData[model][p] > 0 ? 'bg-blue-100 font-semibold' : ''}">${totalData[model][p]}</td>`).join('')}
                                    <td class="py-3 px-2 text-center text-xs bg-blue-200 font-bold text-blue-800">${totalData[model].total}</td>
                                </tr>`;
                            }).join('');
                        }
                    },
                    pdi: {
                        init() {
                             ui.$('refreshPdiBtn').addEventListener('click', () => this.refresh());
                             ui.$('statusFilter').addEventListener('change', () => this.filterCompleted());
                             ui.$('pdiDate').value = new Date().toISOString().split('T')[0];
                        },
                        refresh() {
                             const selectedDate = ui.$('pdiDate').value;
                            let filteredRecords = state.records;
                            if (selectedDate) {
                                filteredRecords = state.records.filter(record => record.timestamp && new Date(record.timestamp).toISOString().split('T')[0] === selectedDate);
                            }
                            const latestByVin = {};
                            filteredRecords.forEach(record => {
                                if (!latestByVin[record.vin] || new Date(record.timestamp) > new Date(latestByVin[record.vin].timestamp)) {
                                    latestByVin[record.vin] = record;
                                }
                            });
                            const latestRecords = Object.values(latestByVin);
                            const pending = latestRecords.filter(record => !record.pdiCompleted);
                            const completed = latestRecords.filter(record => record.pdiCompleted);
                            
                            ui.$('pendingCount').textContent = pending.length;
                            ui.$('completedCount').textContent = completed.length;
                            
                            const progressPercent = latestRecords.length > 0 ? Math.round((completed.length / latestRecords.length) * 100) : 0;
                            ui.$('progressBar').style.width = `${progressPercent}%`;
                            ui.$('progressText').textContent = `${completed.length}/${latestRecords.length} (${progressPercent}%)`;
                            
                            ui.$('pendingList').innerHTML = pending.length === 0 ? `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-2">üöó</div><div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div></div>` : pending.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(rec => this.createPdiCard(rec, 'pending')).join('');
                            this.filterCompleted();
                        },
                        filterCompleted() {
                            const selectedDate = ui.$('pdiDate').value;
                            const statusFilter = ui.$('statusFilter').value;
                            let filteredRecords = state.records;
                            if (selectedDate) {
                                filteredRecords = state.records.filter(record => record.timestamp && new Date(record.timestamp).toISOString().split('T')[0] === selectedDate);
                            }
                            const latestByVin = {};
                            filteredRecords.forEach(record => {
                                if (!latestByVin[record.vin] || new Date(record.timestamp) > new Date(latestByVin[record.vin].timestamp)) {
                                    latestByVin[record.vin] = record;
                                }
                            });
                            let completed = Object.values(latestByVin).filter(record => record.pdiCompleted);
                            if(statusFilter !== 'all'){
                                completed = completed.filter(rec => rec.status === statusFilter);
                            }
                            ui.$('completedList').innerHTML = completed.length === 0 ? `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-2">üìã</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div></div>` : completed.sort((a,b) => new Date(b.lastModified || b.timestamp) - new Date(a.lastModified || a.timestamp)).map(rec => this.createPdiCard(rec, 'completed')).join('');
                        },
                        createPdiCard(record, type) {
                             const isCompleted = type === 'completed';
                            const statusColor = record.status === 'OK' ? 'text-green-700' : record.status === 'NG' ? 'text-red-700' : 'text-yellow-700';
                            const statusIcon = record.status === 'OK' ? '‚úÖ' : record.status === 'NG' ? '‚ùå' : 'üîß';
                            const cardBg = isCompleted ? 'bg-white' : 'bg-yellow-50';
                            const borderColor = isCompleted ? (record.status === 'OK' ? 'border-l-4 border-l-green-500' : record.status === 'NG' ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-yellow-500') : 'border border-yellow-200';
                            const accBadge = record.accStatus ? `<span class="px-2 py-1 rounded text-xs font-bold bg-sky-100 text-sky-800">ACC</span>` : '';

                            return `
                                <div class="${cardBg} ${borderColor} rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-start gap-4">
                                        <div class="text-3xl">${statusIcon}</div>
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="font-bold text-gray-800">VIN: ${record.vin}</span>
                                                        <button onclick="ui.copyVin('${record.vin}', this)" class="copy-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-0.5 rounded text-xs font-medium">üìã COPY</button>
                                                    </div>
                                                    <div class="text-xs text-gray-500">ID: ${record.id}</div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="flex items-center gap-2 justify-end">
                                                        ${accBadge}
                                                        <div class="text-lg ${statusColor} font-semibold">${record.status}</div>
                                                    </div>
                                                    <div class="text-sm text-gray-600">${new Date(record.timestamp).toLocaleTimeString('th-TH')}</div>
                                                </div>
                                            </div>
                                            <div class="mt-3 pt-3 border-t border-gray-200 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                <div><span class="text-gray-500">‡∏£‡∏∏‡πà‡∏ô:</span> ${record.adminData?.carModel || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</div>
                                                <div><span class="text-gray-500">‡∏™‡∏µ:</span> ${record.adminData?.carColor || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</div>
                                                <div><span class="text-gray-500">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à:</span> ${record.inspector}</div>
                                                <div><span class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> ${new Date(record.timestamp).toLocaleDateString('th-TH')}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                        }
                    },
                    admin: {
                        init() {
                            ui.$('adminSearchBtn').addEventListener('click', () => this.adminSearch());
                            ui.$('importExcelBtnAdmin').addEventListener('click', () => this.importExcel());
                            ui.$('excelUpload').addEventListener('change', (e) => this.handleExcelUpload(e));
                            ui.$('saveAdminChangesBtn').addEventListener('click', () => this.saveAdminChanges());
                            ui.$('addAdminDefectCardBtn').addEventListener('click', () => this.addAdminDefectCard());
                            ui.$('refreshAdminRecordsBtn').addEventListener('click', () => this.refresh());
                            ui.$('sendSummaryToLineBtn').addEventListener('click', () => ui.showToast('üöß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'error'));
                            ui.$('adminStatusChangeContainer').addEventListener('click', (e) => {
                                const btn = e.target.closest('.admin-status-btn');
                                if (btn) this.adminUpdateRecordStatus(btn.dataset.status);
                            });
                             ui.$('adminRecordsDate').value = new Date().toISOString().split('T')[0];
                        },
                        refresh() {
                            const selectedDate = ui.$('adminRecordsDate').value;
                            let filteredRecords = state.records;
                            if (selectedDate) {
                                filteredRecords = filteredRecords.filter(r => r.timestamp && new Date(r.timestamp).toISOString().split('T')[0] === selectedDate);
                            }
                            
                            const latestByVin = {};
                            filteredRecords.forEach(r => {
                                if (!latestByVin[r.vin] || new Date(r.timestamp) > new Date(latestByVin[r.vin].timestamp)) {
                                    latestByVin[r.vin] = r;
                                }
                            });
                            const latestRecords = Object.values(latestByVin);
                            const recordsForStats = latestRecords.filter(r => !r.imported);
                            
                            ui.$('adminTotalCount').textContent = recordsForStats.length;
                            ui.$('adminOkCount').textContent = recordsForStats.filter(r => r.status === 'OK').length;
                            ui.$('adminNgCount').textContent = recordsForStats.filter(r => r.status === 'NG').length;
                            ui.$('adminRepairCount').textContent = recordsForStats.filter(r => r.status === 'REPAIR').length;

                            const tbody = ui.$('adminRecordsTable');
                            if (latestRecords.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                                return;
                            }
                            
                            tbody.innerHTML = latestRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(record => {
                                const statusColor = record.status === 'OK' ? 'bg-green-50 text-green-700' : record.status === 'NG' ? 'bg-red-50 text-red-700' : 'bg-yellow-50 text-yellow-700';
                                const pdiStatus = record.pdiCompleted ? `<span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>` : `<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
                                const accBadge = record.accStatus ? `<span class="px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-800">ACC</span>` : '';
                                const importedBadge = record.imported ? `<span class="px-2 py-1 rounded text-xs font-medium bg-gray-200 text-gray-700 ml-1">IMP</span>` : '';

                                return `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="py-3 px-4 font-medium">${record.vin}</td>
                                        <td class="py-3 px-4">${record.adminData?.carModel || 'N/A'}</td>
                                        <td class="py-3 px-4">${record.adminData?.carColor || 'N/A'}</td>
                                        <td class="py-3 px-4"><div class="flex items-center gap-1"><span class="px-2 py-1 rounded text-xs font-medium ${statusColor}">${record.status}</span>${accBadge}${importedBadge}</div></td>
                                        <td class="py-3 px-4">${record.inspector}</td>
                                        <td class="py-3 px-4 text-xs">${new Date(record.timestamp).toLocaleString('th-TH')}</td>
                                        <td class="py-3 px-4">${pdiStatus}</td>
                                        <td class="py-3 px-4">
                                            <button onclick="controllers.admin.quickEditRecord('${record.vin}')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="controllers.admin.deleteRecord('${record.firebaseKey}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-xs">üóëÔ∏è ‡∏•‡∏ö</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('');
                        },
                        adminSearch() {
                            const vin = ui.$('adminVin').value.trim();
                            if (!vin) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà VIN', 'error');
                                return;
                            }
                            
                            const vinRecords = state.records.filter(r => r.vin === vin);
                            const resultDiv = ui.$('adminSearchResult');
                            const editForm = ui.$('adminEditForm');
                            
                            if (vinRecords.length === 0) {
                                resultDiv.innerHTML = '<div class="text-gray-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                                editForm.classList.add('hidden');
                                return;
                            }
                            
                            const latest = vinRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                            state.admin.currentEditingVin = vin;
                            state.admin.currentEditingRecord = latest;
                            
                             const sortedHistory = vinRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            const historyHtml = `
                                <details open class="mt-4 text-sm bg-gray-50 p-3 rounded-lg border">
                                    <summary class="font-medium text-gray-800 cursor-pointer hover:text-indigo-700">
                                        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${sortedHistory.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
                                    </summary>
                                    <div class="mt-3 pt-3 border-t pl-4 border-l-2 border-gray-200 space-y-3">
                                        ${sortedHistory.map((rec, index) => {
                                            const statusColor = rec.status === 'OK' ? 'text-green-700' : rec.status === 'NG' ? 'text-red-700' : 'text-yellow-700';
                                            const accBadge = rec.accStatus ? `<span class="px-1.5 py-0.5 rounded text-xs font-bold bg-sky-100 text-sky-800">ACC</span>` : '';
                                            return `
                                            <div class="p-2 rounded-md bg-white border border-gray-200">
                                                <div class="flex justify-between items-center">
                                                    <span class="font-semibold text-gray-800">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${sortedHistory.length - index}: <span class="font-bold ${statusColor}">${rec.status}</span> ${accBadge}</span>
                                                    <span class="text-xs text-gray-500">${new Date(rec.timestamp).toLocaleString('th-TH')}</span>
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">‡πÇ‡∏î‡∏¢: ${rec.inspector}</div>
                                            </div>
                                        `}).join('')}
                                    </div>
                                </details>
                            `;
                            
                            // --- NEW MERGING LOGIC FOR DISPLAY ---
                            const adminDefectsToDisplay = (latest.adminDefects || []).reduce((acc, defect) => {
                                const position = defect.position || 'N/A';
                                const category = defect.categoryDefect || 'N/A';
                                const incharge = defect.incharge || 'N/A';
                                const defectNg = defect.defectNg || 'N/A';
                                const mergeKey = `${position}|${category}|${incharge}|${defectNg}`;

                                // If we haven't seen this exact combination before, add it.
                                if (!acc[mergeKey]) {
                                    // Take a copy of the first defect we encounter for this combination.
                                    acc[mergeKey] = { ...defect };
                                }
                                // If we have seen it, we do nothing, effectively ignoring the duplicate for display purposes.
                                return acc;
                            }, {});
                            const finalAdminDefects = Object.values(adminDefectsToDisplay);
                            // --- END NEW MERGING LOGIC ---
                            
                            const defectsHtml = `
                                <div class="mt-4">
                                    <h4 class="font-medium text-gray-800 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                                    <div class="space-y-3">
                                        ${(latest.defects && latest.defects.length > 0) ? `
                                            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                                <h5 class="font-semibold text-red-700 mb-2">‡∏à‡∏≤‡∏Å QC</h5>
                                                <div class="space-y-2 text-xs">
                                                    ${latest.defects.map(defect => `
                                                        <div class="p-2 bg-white rounded border border-red-100">
                                                            <p class="font-medium text-red-800">${defect.position || 'N/A'}: <span class="font-normal text-red-600">${defect.defectDescription || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</span></p>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${(finalAdminDefects && finalAdminDefects.length > 0) ? `
                                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                                <h5 class="font-semibold text-orange-700 mb-2">‡∏à‡∏≤‡∏Å Admin / Import</h5>
                                                <div class="space-y-2 text-xs">
                                                    ${finalAdminDefects.map(defect => `
                                                        <div class="p-2 bg-white rounded border border-orange-100">
                                                            <p class="font-medium text-orange-800">${defect.position || 'N/A'}: <span class="font-normal text-orange-600">${defect.defectNg || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</span></p>
                                                            <div class="grid grid-cols-2 gap-x-4 mt-1 text-gray-600">
                                                                <span><strong>Category:</strong> ${defect.categoryDefect || '-'}</span>
                                                                <span><strong>Incharge:</strong> ${defect.incharge || '-'}</span>
                                                                <span><strong>Status Repair:</strong> ${defect.statusRepair || '-'}</span>
                                                                <span><strong>Repair Date:</strong> ${defect.repairDate ? new Date(defect.repairDate).toLocaleDateString('th-TH') : '-'}</span>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${(!latest.defects || latest.defects.length === 0) && (!finalAdminDefects || finalAdminDefects.length === 0) ? `
                                            <p class="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</p>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            
                            const allPhotos = vinRecords.flatMap(rec => rec.photos || []);
                            const photoGalleryHtml = allPhotos.length > 0 ? `
                                <div class="mt-4">
                                    <h4 class="font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${allPhotos.length} ‡∏£‡∏π‡∏õ):</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                        ${allPhotos.map((photoSrc, index) => `
                                            <div class="relative group">
                                                <img src="${photoSrc}" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${index + 1}" class="w-full h-40 object-cover rounded-lg border cursor-pointer hover:opacity-80 transition-opacity" onclick="controllers.photoModal.view('${photoSrc}', '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${index + 1} ‡∏à‡∏≤‡∏Å VIN: ${latest.vin}')">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-b-lg">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${index + 1}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '<div class="mt-4 text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>';

                            resultDiv.innerHTML = `
                                <div class="bg-white border border-gray-200 rounded-xl p-4 space-y-3 relative">
                                    <div class="flex items-center justify-between flex-wrap gap-2">
                                        <div class="font-bold text-lg text-blue-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
                                        <div class="flex items-center gap-2">
                                             <button onclick="controllers.line.sendVinToLine('${latest.firebaseKey}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-medium">üì± ‡∏™‡πà‡∏á LINE</button>
                                            <button onclick="controllers.admin.toggleEditForm()" id="editToggleBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm font-medium">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm pt-2 border-t">
                                        <div><strong>‡πÄ‡∏•‡∏Ç VIN:</strong> ${latest.vin}</div>
                                        <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${latest.status}</div>
                                        <div><strong>PDI Status:</strong> ${latest.pdiCompleted ? '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</div>
                                        <div><strong>‡∏£‡∏∏‡πà‡∏ô:</strong> ${latest.adminData?.carModel || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</div>
                                        <div><strong>‡∏™‡∏µ:</strong> ${latest.adminData?.carColor || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</div>
                                        <div><strong>PDI Date:</strong> ${latest.adminData?.pdiDate ? new Date(latest.adminData.pdiDate).toLocaleDateString('th-TH') : '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</div>
                                    </div>
                                    ${historyHtml}
                                    ${defectsHtml}
                                    ${photoGalleryHtml}
                                </div>`;
                            
                            this.populateEditForm(latest);
                        },
                        populateEditForm(record) {
                            ui.$('carModel').value = record.adminData?.carModel || '';
                            ui.$('carColor').value = record.adminData?.carColor || '';
                            ui.$('adminPdiDate').value = record.adminData?.pdiDate || new Date().toISOString().split('T')[0];
                            state.admin.defectCards = record.adminDefects || [];
                            state.admin.defectCardCounter = state.admin.defectCards.length;
                            this.renderAdminDefectCards();
                        },
                        saveAdminChanges() {
                             if (!state.admin.currentEditingVin || !state.admin.currentEditingRecord) return;
                            const adminData = {
                                carModel: ui.$('carModel').value.trim(),
                                carColor: ui.$('carColor').value.trim(),
                                pdiDate: ui.$('adminPdiDate').value
                            };
                            
                            if (!adminData.carModel || !adminData.carColor) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ ‡πÅ‡∏•‡∏∞ ‡∏™‡∏µ‡∏£‡∏ñ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                                return;
                            }
                            
                            const updates = {
                                adminData,
                                adminDefects: [...state.admin.defectCards],
                                lastModified: new Date().toISOString(),
                                modifiedBy: state.currentUser.name,
                                pdiCompleted: true,
                            };

                            services.db.updateRecord(state.admin.currentEditingRecord.firebaseKey, updates)
                                .then(() => {
                                    ui.showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                                    this.toggleEditForm();
                                    this.adminSearch(); 
                                })
                                .catch(() => ui.showToast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'));
                        },
                        toggleEditForm() {
                            const editForm = ui.$('adminEditForm');
                            const toggleBtn = ui.$('editToggleBtn');
                            const isHidden = !editForm.classList.contains('hidden');
                            editForm.classList.toggle('hidden', isHidden);
                            if (toggleBtn) {
                                toggleBtn.innerHTML = isHidden ? '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‚ùå ‡∏õ‡∏¥‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                                toggleBtn.className = `text-white px-3 py-1 rounded-lg text-sm font-medium ${isHidden ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-600 hover:bg-red-700'}`;
                            }
                        },
                        quickEditRecord(vin) {
                            ui.$('adminVin').value = vin;
                            this.adminSearch();
                            const editForm = ui.$('adminEditForm');
                            if(editForm.classList.contains('hidden')){
                                this.toggleEditForm();
                            }
                        },
                        async deleteRecord(firebaseKey) {
                             const confirmed = await ui.showConfirm({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?', confirmColor: 'red'});
                            if (confirmed) {
                                services.db.deleteRecord(firebaseKey)
                                    .then(() => ui.showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'))
                                    .catch(() => ui.showToast('‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'));
                            }
                        },
                        addAdminDefectCard() {
                           state.admin.defectCardCounter++;
                            const cardId = `admin-defect-${Date.now()}`;
                            const today = new Date().toISOString().split('T')[0];
                            const newCard = { 
                                id: cardId, 
                                categoryDefect: '', 
                                incharge: '', 
                                pdiDate: today,
                                position: '', 
                                defectNg: '', 
                                statusRepair: '', 
                                repairDate: today
                            };
                            if (!state.admin.defectCards) {
                                state.admin.defectCards = [];
                            }
                            state.admin.defectCards.push(newCard);
                            this.renderAdminDefectCards();
                        },
                        removeAdminDefectCard(cardId) {
                           state.admin.defectCards = state.admin.defectCards.filter(card => card.id !== cardId);
                            this.renderAdminDefectCards();
                        },
                        updateAdminDefectCard(cardId, field, value) {
                            const card = state.admin.defectCards.find(c => c.id === cardId);
                            if (card) {
                                card[field] = value;
                            }
                        },
                        renderAdminDefectCards() {
                           const container = ui.$('adminDefectCardsContainer');
                            const cardColors = ['bg-red-50 border-red-200', 'bg-blue-50 border-blue-200', 'bg-green-50 border-green-200', 'bg-yellow-50 border-yellow-200', 'bg-purple-50 border-purple-200', 'bg-pink-50 border-pink-200', 'bg-indigo-50 border-indigo-200', 'bg-orange-50 border-orange-200'];
                            if (!state.admin.defectCards || state.admin.defectCards.length === 0) {
                                container.innerHTML = '';
                                ui.$('adminNoDefectMessage').classList.remove('hidden');
                                return;
                            }
                            ui.$('adminNoDefectMessage').classList.add('hidden');
                            container.innerHTML = state.admin.defectCards.map((card, index) => {
                                const positionNumber = index + 1;
                                const colorClass = cardColors[index % cardColors.length];
                                return `
                                <div class="border-2 ${colorClass} p-6 rounded-xl relative space-y-4">
                                    <div class="flex justify-between items-center">
                                        <h4 class="font-bold text-gray-800">üîß Position ${positionNumber}</h4>
                                        <button onclick="controllers.admin.removeAdminDefectCard('${card.id}')" class="text-red-500 hover:text-red-700 bg-red-100 hover:bg-red-200 w-8 h-8 rounded-full flex items-center justify-center transition-colors">‚úï</button>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                         <div>
                                             <label class="block text-sm font-medium text-gray-700 mb-2">Category Defect</label>
                                             <input type="text" list="categoryDefectList" value="${card.categoryDefect || ''}" onchange="controllers.admin.updateAdminDefectCard('${card.id}', 'categoryDefect', this.value)" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                             <datalist id="categoryDefectList"><option value="Appearance"><option value="Appearance/Part replace"><option value="Appearance/Re Dent"><option value="Appearance/Repaint"><option value="Appearance/Repolishing"><option value="BYD Transport"><option value="BYD paint."><option value="Part missing /waiting order"><option value="Technical issue"></datalist>
                                         </div>
                                         <div>
                                             <label class="block text-sm font-medium text-gray-700 mb-2">Incharge</label>
                                             <input type="text" list="inchargeList" value="${card.incharge || ''}" onchange="controllers.admin.updateAdminDefectCard('${card.id}', 'incharge', this.value)" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                             <datalist id="inchargeList"><option value="BYD Assembly."><option value="BYD paint."><option value="BYD part."><option value="BYD Transport"><option value="JWD Transport"><option value="N/A"></datalist>
                                         </div>
                                         <div>
                                             <label class="block text-sm font-medium text-gray-700 mb-2">PDI Date (at BYD)</label>
                                             <input type="date" value="${card.pdiDate || ''}" onchange="controllers.admin.updateAdminDefectCard('${card.id}', 'pdiDate', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                         </div>
                                         <div>
                                             <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                                             <input type="text" list="positionList" value="${card.position || ''}" onchange="controllers.admin.updateAdminDefectCard('${card.id}', 'position', this.value)" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                             <datalist id="positionList"><option value="AEB system warning hold on."><option value="battery"><option value="Brake light"><option value="Car cabin"><option value="Engines"><option value="Front car carpet LH"><option value="Front Seat RH"><option value="Mileage"><option value="Monitor"><option value="PROTECTIVE TRIM COVER, WHEEL NUT LH"><option value="Rear door guard LH"><option value="Tailgate"><option value="Tailgate Wiper"><option value="TPMS"><option value="Transport mode"><option value="VIN Number Code"><option value="VMT"><option value="‡πÅ‡∏ú‡πà‡∏ô‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π RH"></datalist>
                                         </div>
                                         <div>
                                             <label class="block text-sm font-medium text-gray-700 mb-2">Defect/NG</label>
                                             <input type="text" list="defectNgList" value="${card.defectNg || ''}" onchange="controllers.admin.updateAdminDefectCard('${card.id}', 'defectNg', this.value)" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                             <datalist id="defectNgList"><option value="Seed Color"><option value="Scratched"><option value="Missing Part"><option value="Drip Paint"><option value="The battery does not reach the specified threshold"><option value="Incorrect"><option value="Discolored"><option value="Crack Paint"><option value="Uneven Color"><option value="Paint Pin Hole"><option value="Dent"><option value="Abnormal"><option value="Washing Not clean"><option value="Rust"><option value="Crack"><option value="Paint Mist"><option value="Glue Stain"><option value="Broken"><option value="Paint Wave"><option value="Polishing Stain"><option value="Anti Rust Stain"><option value="Dirty"><option value="Rain Stain"><option value="Paint Scar"><option value="Tear"><option value="Paint Blistering"><option value="Blistering"><option value="Chemical Pen Mark"><option value="Incomplete Assembly"><option value="Gap out of STD."><option value="AEB system warning hold on."><option value="Distorted"><option value="Over Mileage"><option value="Spot Paint"><option value="Tire pressure below standard"><option value="Oil Stain"><option value="Bubble"><option value="Wrinkled Paint"><option value="Paint Stain"><option value="Missing Part (Cover bag)"><option value="Shake"><option value="Sanding mark"><option value="Blister Paint"><option value="Different color shade"><option value="Freshly washed"><option value="Yellow Stain"><option value="Sticker Bubble"><option value="Squeeze"><option value="Abnormal noise"><option value="Under-Clear Dirt"><option value="Swag color"><option value="Embossed Color"><option value="Incomplete Paint Coverage"><option value="Debris"><option value="Hole plug Missing Part"><option value="Broken Sealer"><option value="Blistering Sealer"><option value="Asphalt stains"><option value="Sealer Particle"><option value="Crap"><option value="Liquid Stains"><option value="Grease Remain"><option value="Grains Or Black Spots"><option value="Voltage Lower than STD."><option value="Bulge"><option value="TPMS Not working"><option value="Water comes in"><option value="Burn marks"><option value="Lower Standard"><option value="CCA lower than STD."><option value="Wet"><option value="Scratch under the clear layer"><option value="Orange Peel"><option value="Molding Trace"><option value="Paint Crack"><option value="Step"><option value="Flake"><option value="Wrap film protection"><option value="Cut"><option value="Fin"><option value="Metallic Particle"><option value="Scratched under the clear layer"><option value="Sealer Wrinkled"><option value="Rust under the clear layer"><option value="Paint wave under the clear layer"><option value="Sealer Trace"><option value="Bad Smell"><option value="Rat bite"><option value="Nail under the wheel"><option value="Bubble under the clear layer"><option value="Paint stain under the clear layer"><option value="Wrinkled Paint under the clear layer"><option value="Over flow"><option value="Deep Scratch"><option value="Tilted"><option value="Thin Paint"><option value="Paint Drip"><option value="Distorted Sealer"><option value="Dirt Inside"><option value="No marked on the nut heads"><option value="Wrinkled Sealer"><option value="Slip"><option value="Burn Mark"><option value="Not Have"><option value="No holes for screws"><option value="Paint Dirp"><option value="The battery does not reach the specified threshold. (lower 45%)"><option value="Matte Finish"><option value="Dirty"><option value="Over Mileage (>30 km)"><option value="Crcak"><option value="Failed"><option value="‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏°.‡∏≠.‡∏Å"><option value="Bulge"><option value="Paint Crack"><option value="Polishing Stains"><option value="Crack"><option value="soft pneumatic"><option value="All Car"></datalist>
                                         </div>
                                          <div>
                                             <label class="block text-sm font-medium text-gray-700 mb-2">Status Repair</label>
                                             <input type="text" list="statusRepairList" value="${card.statusRepair || ''}" onchange="controllers.admin.updateAdminDefectCard('${card.id}', 'statusRepair', this.value)" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                                             <datalist id="statusRepairList"><option value="Note NG then both confirmed OK"><option value="Note NG and repaired"><option value="Waiting Repair"><option value="Note NG then BYD ACC"><option value="Noted NG and Wating part."></datalist>
                                         </div>
                                         <div>
                                             <label class="block text-sm font-medium text-gray-700 mb-2">Repair Date</label>
                                             <input type="date" value="${card.repairDate || ''}" onchange="controllers.admin.updateAdminDefectCard('${card.id}', 'repairDate', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                                         </div>
                                    </div>
                                </div>
                                `;
                            }).join('');
                        },
                        importExcel() {
                             ui.$('excelUpload').click();
                        },
                        handleExcelUpload(event) {
                            const file = event.target.files[0];
                            if (!file) return;

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const importBtnText = ui.$('importBtnText');
                                const importBtnSpinner = ui.$('importBtnSpinner');
                                const importBtn = ui.$('importExcelBtnAdmin');
                                
                                importBtnText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
                                importBtnSpinner.classList.remove('hidden');
                                importBtn.disabled = true;

                                try {
                                    const data = new Uint8Array(e.target.result);
                                    const workbook = XLSX.read(data, { type: 'array', cellDates:true });
                                    const firstSheetName = workbook.SheetNames[0];
                                    const worksheet = workbook.Sheets[firstSheetName];
                                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
                                    
                                    this.processImportedData(jsonData).finally(() => {
                                        importBtnText.textContent = "üìä IMPORT EXCEL";
                                        importBtnSpinner.classList.add('hidden');
                                        importBtn.disabled = false;
                                    });
                                } catch (error) {
                                    console.error("Error reading Excel file:", error);
                                    ui.showToast("‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
                                    importBtnText.textContent = "üìä IMPORT EXCEL";
                                    importBtnSpinner.classList.add('hidden');
                                    importBtn.disabled = false;
                                }
                            };
                            reader.readAsArrayBuffer(file);
                            event.target.value = ''; // Allow re-uploading the same file
                        },
                        async processImportedData(importedRows) {
                            if (!importedRows || importedRows.length === 0) {
                                ui.showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel", "error");
                                return;
                            }
                             if (!state.currentUser) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                                return;
                            }

                            const columnMap = {
                                'vin': ['Vin', 'VIN', 'vin'],
                                'stockStatus': ['Stock of Status', 'Stock Status'],
                                'categoryDefect': ['Category defect', 'Category Defect'],
                                'incharge': ['Incharge'],
                                'pdiDate': ['PDI Date (at BYD)', 'PDI Date'],
                                'position': ['Position'],
                                'defectNg': ['Defect/NG', 'Defect NG'],
                                'statusRepair': ['Status Repair'],
                                'repairDate': ['Repair Date']
                            };

                            const normalizedData = importedRows.map(row => {
                                const newRow = {};
                                for (const key in columnMap) {
                                    const possibleHeaders = columnMap[key];
                                    const foundHeader = possibleHeaders.find(header => row[header] !== undefined);
                                    if (foundHeader) newRow[key] = row[foundHeader];
                                }
                                return newRow;
                            });

                            // --- NEW: SKIP EXISTING VINS ---
                            const existingVins = new Set(state.records.map(r => r.vin));
                            const rowsToProcess = [];
                            let skippedExistingCount = 0;

                            normalizedData.forEach(row => {
                                if (row.vin && existingVins.has(row.vin)) {
                                    skippedExistingCount++;
                                } else {
                                    rowsToProcess.push(row);
                                }
                            });

                            if (skippedExistingCount > 0) {
                                ui.showToast(`‡∏Ç‡πâ‡∏≤‡∏° ${skippedExistingCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ VIN ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                            }

                            if (rowsToProcess.length === 0) {
                                ui.showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• VIN ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)", "error");
                                return;
                            }
                            // --- END: SKIP EXISTING VINS ---

                            // --- Date Validation Logic (uses rowsToProcess now) ---
                            const oneYearAgo = new Date();
                            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                            
                            const validRows = [];
                            let rejectedCount = 0;

                            rowsToProcess.forEach(row => {
                                const dateValue = row.pdiDate;
                                if (dateValue) {
                                    try {
                                        const recordDate = new Date(dateValue);
                                        if (!isNaN(recordDate.getTime()) && recordDate >= oneYearAgo) {
                                            validRows.push(row);
                                        } else {
                                            rejectedCount++;
                                        }
                                    } catch (e) {
                                        rejectedCount++; // Invalid date format
                                    }
                                } else {
                                    rejectedCount++; // No date, cannot verify age
                                }
                            });

                            if (rejectedCount > 0) {
                                ui.showToast(`‡∏´‡πâ‡∏≤‡∏° IMPORT ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏õ‡∏µ (${rejectedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°)`, 'error');
                            }

                            if (validRows.length === 0) {
                                ui.showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)", "error");
                                return;
                            }

                            ui.showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${validRows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`, "success");

                            const groupedByVin = validRows.reduce((acc, row) => {
                                const vin = row.vin;
                                if (vin) {
                                    if (!acc[vin]) acc[vin] = [];
                                    acc[vin].push(row);
                                }
                                return acc;
                            }, {});
                            
                            let updatedCount = 0;
                            let newCount = 0;

                            for (const vin in groupedByVin) {
                                const defectsForVin = groupedByVin[vin];
                                const latestRecord = state.records.filter(r => r.vin === vin).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

                                let targetRecord;
                                let isNewRecord = false;

                                if (latestRecord) {
                                    targetRecord = { ...latestRecord };
                                    targetRecord.adminDefects = targetRecord.adminDefects || [];
                                    updatedCount++;
                                } else {
                                    targetRecord = {
                                        id: Date.now() + Math.random(),
                                        vin: vin,
                                        status: 'REPAIR',
                                        timestamp: new Date().toISOString(),
                                        inspector: state.currentUser.name,
                                        pdiCompleted: true,
                                        adminData: {},
                                        adminDefects: [],
                                        imported: true, // Mark as imported
                                    };
                                    isNewRecord = true;
                                    newCount++;
                                }
                                
                                const firstDefect = defectsForVin[0];
                                if (firstDefect.pdiDate) {
                                    let pdiDateValue = firstDefect.pdiDate;
                                    try {
                                         if (pdiDateValue instanceof Date) {
                                            targetRecord.adminData.pdiDate = pdiDateValue.toISOString().split('T')[0];
                                        } else {
                                            targetRecord.adminData.pdiDate = new Date(pdiDateValue).toISOString().split('T')[0];
                                        }
                                    } catch(e){
                                         console.warn("Could not parse PDI Date:", pdiDateValue);
                                         targetRecord.adminData.pdiDate = pdiDateValue; // Keep original if parsing fails
                                    }
                                }

                                // --- MERGING LOGIC for defects ---
                                const mergedDefects = defectsForVin.reduce((acc, defectRow) => {
                                    const position = defectRow.position || 'N/A';
                                    const category = defectRow.categoryDefect || 'N/A';
                                    const incharge = defectRow.incharge || 'N/A';
                                    const defectNg = defectRow.defectNg || 'N/A';
                                    const mergeKey = `${position}|${category}|${incharge}|${defectNg}`;

                                    if (!acc[mergeKey]) {
                                        acc[mergeKey] = {
                                            id: `imported-${Date.now()}-${Math.random()}`,
                                            stockStatus: defectRow.stockStatus || '',
                                            categoryDefect: category,
                                            incharge: incharge,
                                            position: position,
                                            defectNg: defectNg, 
                                            statusRepair: defectRow.statusRepair || '',
                                            repairDate: ''
                                        };
                                    }

                                    if (defectRow.statusRepair) {
                                        acc[mergeKey].statusRepair = defectRow.statusRepair;
                                    }

                                    if (defectRow.repairDate) {
                                        try {
                                            const newDate = new Date(defectRow.repairDate);
                                            const existingDate = acc[mergeKey].repairDate ? new Date(acc[mergeKey].repairDate) : null;
                                            if (!existingDate || newDate > existingDate) {
                                                acc[mergeKey].repairDate = newDate.toISOString().split('T')[0];
                                            }
                                        } catch (e) {
                                            console.warn("Could not parse Repair Date for merging, keeping existing:", defectRow.repairDate);
                                        }
                                    }
                                    return acc;
                                }, {});

                                const finalDefects = Object.values(mergedDefects);
                                
                                targetRecord.adminDefects = (targetRecord.adminDefects || []).filter(d => !d.id || !d.id.startsWith('imported-'));
                                finalDefects.forEach(defect => targetRecord.adminDefects.push(defect));
                                
                                targetRecord.lastModified = new Date().toISOString();
                                targetRecord.modifiedBy = state.currentUser.name + ' (Import)';

                                if (isNewRecord) {
                                    await services.db.saveRecord(targetRecord);
                                } else {
                                    await services.db.updateRecord(targetRecord.firebaseKey, targetRecord);
                                }
                            }
                            
                            ui.showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏° ${newCount} ‡∏Ñ‡∏±‡∏ô, ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${updatedCount} ‡∏Ñ‡∏±‡∏ô`, 'success');
                        },
                        async adminUpdateRecordStatus(newStatus) {
                            if (!state.admin.currentEditingRecord) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ VIN ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                                return;
                            }

                            const confirmed = await ui.showConfirm({
                                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
                                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á VIN: ${state.admin.currentEditingRecord.vin} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                                confirmColor: 'blue'
                            });

                            if (confirmed) {
                                const updates = {
                                    status: newStatus,
                                    accStatus: newStatus === 'OK' ? state.admin.currentEditingRecord.accStatus : false, // preserve ACC if new status is OK
                                    lastModified: new Date().toISOString(),
                                    modifiedBy: `${state.currentUser.name} (Admin Quick Change)`
                                };

                                services.db.updateRecord(state.admin.currentEditingRecord.firebaseKey, updates)
                                    .then(() => {
                                        ui.showToast(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                                        this.adminSearch(); // Refresh the search result
                                    })
                                    .catch(err => {
                                        console.error(err);
                                        ui.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error');
                                    });
                            }
                        }
                    },
                    user: {
                        init() {
                            ui.$('addUserBtn').addEventListener('click', () => this.openUserModal(null));
                            ui.$('saveUserBtn').addEventListener('click', () => this.saveUser());
                            ui.$('cancelUserModalBtn').addEventListener('click', () => this.closeUserModal());
                            ui.$('closeUserModalBtn').addEventListener('click', () => this.closeUserModal());
                        },
                        refresh() {
                            this.renderUsersTable();
                            this.updateUserStats();
                        },
                        renderUsersTable() {
                            const tbody = ui.$('userRecordsTable');
                            if (!state.users || state.users.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
                                return;
                            }
                            tbody.innerHTML = state.users.map(user => {
                                const roleBadge = user.role === 'ADMIN' ? `<span class="px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-700">üëë ADMIN</span>` : `<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">üë§ USER</span>`;
                                const statusBadge = user.status === 'Active' ? `<span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">üü¢ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</span>` : `<span class="px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700">üî¥ ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`;
                                
                                return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-3 px-4">
                                        <div class="font-medium">${user.name}</div>
                                        <div class="text-xs text-gray-500">${user.username}</div>
                                    </td>
                                    <td class="py-3 px-4">${roleBadge}</td>
                                    <td class="py-3 px-4">${user.department || 'N/A'}</td>
                                    <td class="py-3 px-4">${statusBadge}</td>
                                    <td class="py-3 px-4">
                                        <button onclick="controllers.user.openUserModal('${user.firebaseKey}')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                        <button onclick="controllers.user.deleteUser('${user.firebaseKey}')" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è ‡∏•‡∏ö</button>
                                    </td>
                                </tr>
                                `;
                            }).join('');
                        },
                        updateUserStats() {
                           ui.$('userTotalCount').textContent = state.users.length;
                           ui.$('userActiveCount').textContent = state.users.filter(u => u.status === 'Active').length;
                           ui.$('userAdminCount').textContent = state.users.filter(u => u.role === 'ADMIN').length;
                        },
                        openUserModal(userKey) {
                            state.user.currentEditingUserKey = userKey;
                            const modal = ui.$('userModal');
                            const title = ui.$('userModalTitle');
                            const nameInput = ui.$('userNameInput');
                            const usernameInput = ui.$('userUsernameInput');
                            const passwordInput = ui.$('userPasswordInput');
                            const departmentInput = ui.$('userDepartmentInput');
                            const roleInput = ui.$('userRoleInput');
                            const statusInput = ui.$('userStatusInput');

                            if (userKey) {
                                title.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                                const user = state.users.find(u => u.firebaseKey === userKey);
                                nameInput.value = user.name;
                                usernameInput.value = user.username;
                                departmentInput.value = user.department;
                                roleInput.value = user.role;
                                statusInput.value = user.status;
                                passwordInput.value = ''; // Clear password field for security
                                passwordInput.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                            } else {
                                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
                                nameInput.value = '';
                                usernameInput.value = '';
                                departmentInput.value = '';
                                passwordInput.value = '';
                                roleInput.value = 'USER';
                                statusInput.value = 'Active';
                                passwordInput.placeholder = '‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                            }
                            modal.classList.remove('hidden');
                            modal.classList.add('flex');
                        },
                        closeUserModal() {
                            ui.$('userModal').classList.add('hidden');
                            ui.$('userModal').classList.remove('flex');
                            state.user.currentEditingUserKey = null;
                        },
                        saveUser() {
                            const password = ui.$('userPasswordInput').value;
                            const userData = {
                                name: ui.$('userNameInput').value.trim(),
                                username: ui.$('userUsernameInput').value.trim(),
                                department: ui.$('userDepartmentInput').value.trim(),
                                role: ui.$('userRoleInput').value,
                                status: ui.$('userStatusInput').value,
                            };

                            if (!userData.name || !userData.username) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Username', 'error');
                                return;
                            }

                            if (!state.user.currentEditingUserKey && !password) {
                                ui.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà', 'error');
                                return;
                            }

                            if (password) {
                                userData.password = password;
                            }
                            
                            services.db.saveUser(state.user.currentEditingUserKey, userData)
                            .then(() => {
                                ui.showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                                this.closeUserModal();
                            }).catch(err => {
                                ui.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                                console.error(err);
                            });
                        },
                        async deleteUser(userKey) {
                            const confirmed = await ui.showConfirm({
                               title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                               text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?',
                               confirmColor: 'red'
                           });
                           if (confirmed) {
                               services.db.deleteUser(userKey)
                                   .then(() => ui.showToast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'))
                                   .catch(err => ui.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error'));
                           }
                        }
                    },
                    camera: {
                        init() {
                             ui.$('closeCameraBtn').addEventListener('click', () => this.close());
                             ui.$('closeCameraBtn2').addEventListener('click', () => this.close());
                        },
                        open() {
                           ui.$('cameraModal').classList.remove('hidden');
                           ui.$('cameraModal').classList.add('flex');
                           this.start();
                        },
                        close() {
                           this.stop();
                           ui.$('cameraModal').classList.add('hidden');
                           ui.$('cameraModal').classList.remove('flex');
                        },
                        stop() {
                           if (state.cameraStream) {
                               state.cameraStream.getTracks().forEach(track => track.stop());
                               state.cameraStream = null;
                           }
                        },
                        async start() {
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({ 
                                    video: { facingMode: 'environment' } 
                                });
                                state.cameraStream = stream;
                                const video = ui.$('cameraVideo');
                                video.srcObject = stream;
                                video.onloadedmetadata = () => {
                                    video.play();
                                    requestAnimationFrame(this.scanFrame.bind(this));
                                };
                                ui.$('scanStatus').textContent = 'üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...';
                            } catch (err) {
                                console.error("Camera Error:", err);
                                ui.$('scanStatus').textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
                                ui.showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', 'error');
                                this.close();
                            }
                        },
                        scanFrame() {
                            if (!state.cameraStream || !state.cameraStream.active) return;
                            
                            const video = ui.$('cameraVideo');
                            const scanStatus = ui.$('scanStatus');

                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                const canvas = ui.$('cameraCanvas');
                                const ctx = canvas.getContext('2d');
                                canvas.height = video.videoHeight;
                                canvas.width = video.videoWidth;
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                                    inversionAttempts: 'dontInvert',
                                });

                                if (code) {
                                    scanStatus.textContent = `‚úÖ ‡∏û‡∏ö QR Code: ${code.data}`;
                                    ui.$('vinInput').value = code.data.trim();
                                    ui.showToast(`‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${code.data.trim()}`, 'success');
                                    this.close();
                                    controllers.qc.searchVin(); // Automatically search after scan
                                } else {
                                     requestAnimationFrame(this.scanFrame.bind(this));
                                }
                            } else {
                                 requestAnimationFrame(this.scanFrame.bind(this));
                            }
                        }
                    },
                    photoModal: {
                        init(){
                            ui.$('closePhotoModalBtn').addEventListener('click', () => this.close());
                            ui.$('closePhotoModalBtn2').addEventListener('click', () => this.close());
                        },
                        view(src, title) {
                            ui.$('photoModalTitle').textContent = title;
                            ui.$('photoModalImage').src = src;
                            ui.$('photoModal').classList.remove('hidden');
                            ui.$('photoModal').classList.add('flex');
                        },
                        close() {
                            ui.$('photoModal').classList.add('hidden');
                            ui.$('photoModal').classList.remove('flex');
                        }
                    },
                    line: {
                         async sendVinToLine(firebaseKey) {
                            const record = state.records.find(r => r.firebaseKey === firebaseKey);
                            if (!record) {
                                ui.showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', 'error');
                                return;
                            }

                            const vinRecords = state.records.filter(r => r.vin === record.vin);
                            const sortedHistory = vinRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            
                            ui.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏£‡∏∏‡∏õ...', 'success');
                            
                            const reportElement = document.createElement('div');
                            reportElement.style.position = 'absolute';
                            reportElement.style.left = '-9999px';
                            reportElement.style.width = '800px';
                            reportElement.style.padding = '20px';
                            reportElement.style.backgroundColor = 'white';
                            reportElement.style.fontFamily = 'Arial, sans-serif';
                            
                            const historyHtml = sortedHistory.map((rec, index) => `
                                <div style="background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 600;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${sortedHistory.length - index}: <span style="color: ${rec.status === 'OK' ? '#16a34a' : rec.status === 'NG' ? '#dc2626' : '#d97706'};">${rec.status}</span> ${rec.accStatus ? '<span style="background-color: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; font-size: 10px; vertical-align: middle;">ACC</span>' : ''}</span>
                                        <span style="font-size: 12px; color: #6b7280;">${new Date(rec.timestamp).toLocaleString('th-TH')}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #4b5563; margin-top: 4px;">‡πÇ‡∏î‡∏¢: ${rec.inspector}</div>
                                </div>
                            `).join('');

                            const defectsHtml = `
                                ${(record.defects && record.defects.length > 0) ? `
                                    <div style="background-color: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-top: 12px;">
                                        <h5 style="font-weight: 600; color: #991b1b; margin-bottom: 8px; font-size: 14px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å QC (${record.defects.length})</h5>
                                        ${record.defects.map(defect => `<p style="font-size: 12px; padding-bottom: 4px;">‚Ä¢ <strong>${defect.position || ''}:</strong> ${defect.defectDescription || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>`).join('')}
                                    </div>` : ''}
                                ${(record.adminDefects && record.adminDefects.length > 0) ? `
                                    <div style="background-color: #ffedd5; border: 1px solid #fed7aa; border-radius: 8px; padding: 12px; margin-top: 12px;">
                                        <h5 style="font-weight: 600; color: #9a3412; margin-bottom: 8px; font-size: 14px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Admin/Import (${record.adminDefects.length})</h5>
                                         ${record.adminDefects.map(defect => `
                                             <div style="font-size: 12px; padding-bottom: 8px; margin-bottom: 8px; border-bottom: 1px solid #fdba74;">
                                                 <p>‚Ä¢ <strong>${defect.position || ''}:</strong> ${defect.defectNg || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
                                                 <p style="margin-top: 4px; color: #78350f;">
                                                     <strong>Category:</strong> ${defect.categoryDefect || '-'} | 
                                                     <strong>Incharge:</strong> ${defect.incharge || '-'} | 
                                                     <strong>Status:</strong> ${defect.statusRepair || '-'}
                                                 </p>
                                             </div>
                                        `).join('')}
                                    </div>` : ''}
                                  ${(!record.defects || record.defects.length === 0) && (!record.adminDefects || record.adminDefects.length === 0) ? `<p class="text-gray-500 text-sm mt-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</p>`: ''}
                            `;
                            
                            const allPhotos = vinRecords.flatMap(rec => rec.photos || []);
                            const photosHtml = allPhotos.length > 0 ? `
                                <h4 style="font-weight: 600; font-size: 16px; margin-top: 16px; margin-bottom: 8px; color: #1f2937;">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${allPhotos.length} ‡∏£‡∏π‡∏õ)</h4>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                    ${allPhotos.map(p => `<img src="${p}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb;"/>`).join('')}
                                </div>
                            ` : '';

                            reportElement.innerHTML = `
                                <div style="border-bottom: 2px solid #4f46e5; padding-bottom: 12px; margin-bottom: 12px;">
                                    <h2 style="font-size: 24px; font-weight: bold; color: #312e81;">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</h2>
                                    <p style="font-size: 18px; font-weight: 600; color: #4338ca;">VIN: ${record.vin}</p>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; font-size: 14px; color: #374151;">
                                    <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${record.status}</p>
                                    <p><strong>PDI Status:</strong> ${record.pdiCompleted ? '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</p>
                                    <p><strong>‡∏£‡∏∏‡πà‡∏ô:</strong> ${record.adminData?.carModel || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</p>
                                    <p><strong>‡∏™‡∏µ:</strong> ${record.adminData?.carColor || '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</p>
                                    <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${new Date(record.timestamp).toLocaleString('th-TH')}</p>
                                    <p><strong>PDI Date:</strong> ${record.adminData?.pdiDate ? new Date(record.adminData.pdiDate).toLocaleDateString('th-TH') : '‡∏£‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</p>
                                </div>
                                <div style="margin-top: 16px;">
                                    <h4 style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #1f2937;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (${sortedHistory.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</h4>
                                    ${historyHtml}
                                </div>
                                <div style="margin-top: 16px;">
                                    ${defectsHtml}
                                </div>
                                ${photosHtml}
                            `;
                            
                            document.body.appendChild(reportElement);

                            try {
                                const canvas = await html2canvas(reportElement, { useCORS: true, allowTaint: true, scale: 2 });
                                const url = canvas.toDataURL('image/png');
                                
                                const modal = document.createElement('div');
                                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                                modal.innerHTML = `
                                    <div class="bg-white rounded-xl max-w-lg w-full">
                                        <div class="p-6 text-center">
                                            <h3 class="text-xl font-bold text-gray-900 mb-4">üì± ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE</h3>
                                            <div class="mb-6"><img src="${url}" alt="Report Preview" class="w-full rounded-lg border shadow-sm"></div>
                                            <div class="space-y-3">
                                                <button onclick="ui.downloadImage('${url}', 'PDI_Report_${record.vin}.png')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                                                <button onclick="ui.copyImageToClipboard(this, '${url}')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                                            </div>
                                        </div>
                                        <div class="p-4 border-t bg-gray-50 text-center">
                                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button>
                                        </div>
                                    </div>`;
                                document.body.appendChild(modal);

                            } catch (error) {
                                console.error("Error generating image:", error);
                                ui.showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", "error");
                            } finally {
                                document.body.removeChild(reportElement);
                            }
                         },
                         async sendDashboardToLine() {
                            const selectedDate = ui.$('dashDate').value;
                            const dateFormatted = selectedDate ? new Date(selectedDate).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) : '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ';
                            
                            const workPeriodEl = ui.$('dashWorkPeriodContainer');
                            const statsEl = ui.$('dashStatsCards');

                            if (!workPeriodEl || !statsEl) {
                                ui.showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                                return;
                            }

                            ui.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏£‡∏∏‡∏õ Dashboard...', 'success');

                            const reportElement = document.createElement('div');
                            reportElement.style.position = 'absolute';
                            reportElement.style.left = '-9999px';
                            reportElement.style.width = '800px';
                            reportElement.style.padding = '20px';
                            reportElement.style.backgroundColor = '#f9fafb'; // Match body bg
                            reportElement.style.fontFamily = 'Arial, sans-serif';

                            const headerHtml = `
                                <div style="border-bottom: 2px solid #4f46e5; padding-bottom: 12px; margin-bottom: 20px; text-align: center;">
                                    <h2 style="font-size: 24px; font-weight: bold; color: #312e81;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Dashboard</h2>
                                    <p style="font-size: 18px; font-weight: 600; color: #4338ca;">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateFormatted}</p>
                                </div>
                            `;
                            
                            const clonedWorkPeriod = workPeriodEl.cloneNode(true);
                            const clonedStats = statsEl.cloneNode(true);
                            clonedWorkPeriod.style.marginBottom = '20px'; // Add some space
                            
                            reportElement.innerHTML = headerHtml + clonedWorkPeriod.outerHTML + clonedStats.outerHTML;
                            document.body.appendChild(reportElement);

                            try {
                                const canvas = await html2canvas(reportElement, { useCORS: true, allowTaint: true, scale: 2 });
                                const url = canvas.toDataURL('image/png');
                                
                                const modal = document.createElement('div');
                                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                                modal.innerHTML = `
                                    <div class="bg-white rounded-xl max-w-lg w-full">
                                        <div class="p-6 text-center">
                                            <h3 class="text-xl font-bold text-gray-900 mb-4">üì± ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Dashboard ‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE</h3>
                                            <div class="mb-6"><img src="${url}" alt="Report Preview" class="w-full rounded-lg border shadow-sm"></div>
                                            <div class="space-y-3">
                                                <button onclick="ui.downloadImage('${url}', 'Dashboard_Report_${selectedDate}.png')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                                                <button onclick="ui.copyImageToClipboard(this, '${url}')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                                            </div>
                                        </div>
                                        <div class="p-4 border-t bg-gray-50 text-center">
                                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button>
                                        </div>
                                    </div>`;
                                document.body.appendChild(modal);

                            } catch (error) {
                                console.error("Error generating dashboard image:", error);
                                ui.showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", "error");
                            } finally {
                                document.body.removeChild(reportElement);
                            }
                        }
                    }
                });
            },
            
            setupEventListeners() {
                ui.$('navButtonsContainer').addEventListener('click', (e) => {
                    const btn = e.target.closest('.tab-btn');
                    if (btn) this.switchTab(btn.dataset.tab);
                });
                
                ui.$('loginBtn').addEventListener('click', () => controllers.auth.openLoginModal());
                ui.$('loginModalBtn').addEventListener('click', () => controllers.auth.handleLogin());
                ui.$('logoutBtn').addEventListener('click', () => controllers.auth.handleLogout());

                ui.$('confirmModalConfirmBtn').addEventListener('click', () => ui.handleConfirm(true));
                ui.$('confirmModalCancelBtn').addEventListener('click', () => ui.handleConfirm(false));

                ui.$('vinInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') controllers.qc.searchVin();
                });
                document.addEventListener('keydown', (e) => {
                    if (!ui.$('statusSection').classList.contains('hidden')) {
                        if(e.key === '1') controllers.qc.selectStatus('OK');
                        if(e.key === '2') controllers.qc.selectStatus('NG');
                    }
                });
            },

            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
                
                ui.$(`section-${tabName}`).classList.remove('hidden');
                ui.$(`tab-${tabName}`).classList.add('active-tab');

                if (controllers[tabName] && typeof controllers[tabName].refresh === 'function') {
                    controllers[tabName].refresh();
                }
            },
        };

        // Start the application
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>

























